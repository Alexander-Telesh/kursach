
$(document).ready(function () {
    var work_id = $("#a_work_id").val();
    var user_id = $("#a_user_id").val();
    var hidden_analogs_count = 0;
    var main_analogs_count = 0;
    var user_marks_limit = $("#a_user_marks_limit").val();
    var is_admin = $("#a_is_admin").val();
    if (user_id == 0 || user_id == '') {
      user_id = null;
    };
    
    $("#analogs_list").html("Загрузка...");
    var sep = '';
    var list = [];
    var list_ids = {};
    var max_marks = 0;

    var tp_typeahead_suggestion = Handlebars.compile($('#tp_typeahead_suggestion').html());
    var tp_confirm_button = Handlebars.compile($('#tp_analog_confirm_btn').html());
    var tp_unconfirm_button = Handlebars.compile($('#tp_analog_unconfirm_btn').html());
    var tp_analog_row_content = Handlebars.compile($('#tp_analog_row_content').html());
    
    function add_button(bwork_id) {
      if (user_id == null || user_id == '' || user_id == '0') {
        return('');
      } else {
        return(tp_confirm_button({work_id: bwork_id}));
      };
    };

    function remove_button(bwork_id) {
      if (user_id == null || user_id == '' || user_id == '0') {
        return('');
      } else {
        return(tp_unconfirm_button({work_id: bwork_id}));
      };
    };

    function recalc_max_marks() {
      max_marks = 0;
      for (var work in list) {
        if (max_marks < parseInt(list[work].markcount)) {
          max_marks = parseInt(list[work].markcount);
        };
      };
    };
    
    function change_analog_markcount(bwork_id, cng_val) {
      list[list_ids[bwork_id]].markcount = parseInt(list[list_ids[bwork_id]].markcount)+cng_val;
      if (max_marks < list[list_ids[bwork_id]].markcount) {
        max_marks = list[list_ids[bwork_id]].markcount;
      } else if ((max_marks - 1) == list[list_ids[bwork_id]].markcount) {
        recalc_max_marks();
      };
    };

    function process_add_button(bwork_id) {
      $("span#analog_confirm"+bwork_id).replaceWith(remove_button(bwork_id));
      $("#analogs_list a.analog_remove").unbind( "click" ); $("#analogs_list a.analog_remove").click(click_remove_button);
      change_analog_markcount(bwork_id, 1);
      recalc_analogs_progress_bars();
    };
    
    function click_add_button () {
      var confirm_button = $( this );
      var analog_id = $( this ).attr('name');
      $.get( "/work"+work_id+"/analog"+analog_id+"/add", function( data ) {
        if (data.status == 'error' && data.msg == 'limit expired') {
          alert("Вы превысили ограничение (не более "+user_marks_limit+") на количество оценок похожих произведений.");
        } else {
            // обновим в массиве данные по отметке текущего выбор юзера, чтобы при нажатии на "ещё n >>" и перестройке списка метки не слетали 
            for (let i = 0; i < list.length; i++) {
              if (list[i].work_id == analog_id) {
                list[i].mark_id = true; //реальный айдишник отметки узнавать не нужно, главное чтобы ненулевой числилась после её выставления
                break;
              }
            }
            process_add_button(analog_id);
        };
      });
      return(false);
    };

    function click_remove_button () {
      var confirm_button = $( this );
      var analog_id = $( this ).attr('name');
      $.get( "/work"+work_id+"/analog"+analog_id+"/remove", function( data ) {
        if (data.remove_status == 1) {
          $("tr#row_analog_"+analog_id).remove();
          del_idx = list_ids[analog_id];
          list.splice(del_idx, 1);
          delete list_ids[analog.work_id];
          for (var id in list_ids) {
            if (list_ids[id] > del_idx) {
              list_ids[id] = list_ids[id] - 1;
            };
          };
        } else {
          // аналогично выставлению метки, убираем из массива данные о ней
          for (let i = 0; i < list.length; i++) {
            if (list[i].work_id == analog_id) {
              list[i].mark_id = '';
              break;
            }
          }
          $("span#analog_remove"+analog_id).replaceWith(add_button(analog_id));
          $("#analogs_list a.analog_confirm").unbind( "click" ); $("#analogs_list a.analog_confirm").click(click_add_button);
          change_analog_markcount(analog_id, -1);
        };
        recalc_analogs_progress_bars();
      });
      return(false);
    };

    function add_analog_in_list(analog, number, with_remove_button, with_hidden) {
        var asep = '';
        var autors_str = '';
        for (i=1; i<=5; i++) {
          var id = analog['autor'+i+'_id'];
          var rusname = analog['autor'+i+'_rusname'];
          var name = analog['autor'+i+'_name'];

          if ((rusname != null && rusname != '') || (name != null && name != '')) {
            autors_str = autors_str+asep;
            if (rusname != null && rusname != '') {
              autors_str = autors_str+rusname;
            } else if (name != null && name != '') {
              autors_str = autors_str+asep+name;
            };
            asep = ', ';
          };
        };

        var work_name = '';
        var wsep = '';

        if (analog.rusname != null && analog.rusname != '') { work_name = analog.rusname; wsep = ' / '; };
        if (analog.name != null && analog.name != '') { work_name = work_name+wsep+analog.name; };

        var confirm_button = '';
        if (with_remove_button || (analog.mark_id != null && analog.mark_id != '') || (user_id == null || user_id == '' || user_id == '0')) {
          confirm_button = remove_button(analog.work_id);
        } else {
          confirm_button = add_button(analog.work_id);
        };

        var avg_work_mark = '';
        if (analog.work_markcount > 0) {
          avg_work_mark = (Math.round(analog.work_marks_sum * 100 / analog.work_markcount) / 100).toFixed(2);
        };

        var year_type = '';
        var ysep = '';
        if (analog.year != null && analog.year != '' && analog.year != 0) {
          year_type = analog.year;
          ysep = ', ';
        };
        if (analog.name_show_im != null && analog.name_show_im != '') {
          year_type = year_type+ysep+analog.name_show_im;
        };
        if (year_type != '') {
          year_type = ' ('+year_type+')';
        };
        
        var row_content = tp_analog_row_content({
          user_id: user_id,
          analog: analog,
          analog_markcount: analog.markcount,
          confirm_button: new Handlebars.SafeString(confirm_button),
          autors_str: autors_str,
          analog_work_id: analog.work_id,
          work_name: work_name,
          year_type: year_type,
          avg_work_mark: avg_work_mark,
          analog_work_markcount: analog.work_markcount,
          is_admin: is_admin,
          main_work_id: work_id
        });
      if ((analog.markcount==1 || number>15) && !with_hidden) {
        hidden_analogs_count++;
      } else {
        if ($("tr").is("#row_analog_"+analog.work_id)) {
          $("tr#row_analog_"+analog.work_id).html(row_content);
        } else {
          $("#analogs_list").append('<tr id="row_analog_'+analog.work_id+'" valign="top">'+row_content+'</tr>');
        };
        sep = ', ';
        main_analogs_count++;
      }
    };

    // Перестроение списка по данным
    function recreate_analogs_list(with_hidden) {
      $("#analogs_list").html("");
      max_marks = 0;
      var number = 0;
      for (var work in list) {
        number++;
        list_ids[list[work].work_id] = work;
        add_analog_in_list(list[work], number, false, with_hidden);
        if (max_marks < parseInt(list[work].markcount)) {
          max_marks = parseInt(list[work].markcount);
        };
      };
    };
    
    // Пересчет прогресс-баров по данным из списка
    function recalc_analogs_progress_bars() {
      for (var work in list) {
        analog = list[work];
        pixels = parseInt(11*analog.markcount/max_marks);
        progress_img = $("div#analog_progress"+analog.work_id);
        left_width = pixels;
        // if (left_width < 0) {left_width = 0;};
        // if (left_width > 11) {left_width = 11;};
        right_width = (11-pixels);
        
        progress_img.css('border-left', left_width+'px solid #3178A8');
        progress_img.css('border-right', right_width+'px solid #B0C0D0');
        progress_img.attr('title', 'Голосов: '+analog.markcount);
      };
    };
  
    $.get( "/work"+work_id+"/analogs", function( analogs ) {
      list = analogs;
      recreate_analogs_list();
      
      recalc_analogs_progress_bars();

      if (hidden_analogs_count > 0) {
         $('#analogs_list1_a').css({'display' : 'inline-block'});
         $('#analogs_list1_a').html((main_analogs_count ? "+ещё " + hidden_analogs_count + " шт. похожего" : "показать"));
      }

      $("#analogs_list a.analog_confirm").unbind( "click" ); $("#analogs_list a.analog_confirm").click(click_add_button);
      $("#analogs_list a.analog_remove").unbind( "click" ); $("#analogs_list a.analog_remove").click(click_remove_button);
    });

    var new_analogs = new Bloodhound({
      datumTokenizer: Bloodhound.tokenizers.obj.whitespace('rusname'),
      queryTokenizer: Bloodhound.tokenizers.whitespace,
      remote: '/search-works.json?q=%QUERY&page=1&onlymatches=1&type=analogs',
      limit: 10
    });

    new_analogs.initialize();

    if ($("div").is("#analogs_input")) {
      $('#analogs_input .typeahead').typeahead({
          hint: true,
          highlight: true,
          minLength: 2
        },
        {
        name: 'add-analog',
        displayKey: function(d) {
          if (d.rusname != null && d.rusname != '') { return d.rusname; }
          else { return d.name; };
        },
        source: new_analogs.ttAdapter(),
        templates: {
          empty: [
            '<div class="empty-message" style="padding: 8px;">',
            'Не могу найти ни одного произведение по данному запросу',
            '</div>'
          ].join('\n'),
          suggestion: tp_typeahead_suggestion
        }
      }).bind("typeahead:selected", function(obj, datum, name) {
        var analog = datum;
        analog['autor1_id'] = analog['autor_id'];
        analog['autor1_rusname'] = analog['autor_rusname'];
        analog['autor1_name'] = analog['autor_name'];
        analog['work_markcount'] = analog['markcount'];
        analog['work_marks_sum'] = analog['markcount']*analog['midmark'];

        $.get( "/work"+work_id+"/analog"+analog.work_id+"/add", function( data ) {
          if (data.status == 'error' && data.msg == 'limit expired') {
            alert("Вы превысили ограничение (не более "+user_marks_limit+") на количество оценок похожих произведений.");
          } else {
            if ($("a").is("#awork"+analog.work_id)) {
              process_add_button(analog.work_id);
            } else {
              // Добавляем аналог к списку
              analog['work_mark'] = data.info.user_mark;
              analog['response_mark'] = data.info.user_response;
              analog['responses_count'] = data.info.responses_count;
              
              list.push(analog);
              list_ids[analog.work_id] = list.length - 1;
              analog['markcount'] = 1;
              analog['analog_pair_id'] = data.pair_id;
              if (max_marks == 0) { max_marks = 1; };
              add_analog_in_list(analog, 1, true, 1);
              recalc_analogs_progress_bars();
            };
            $("#analogs_list a.analog_remove").unbind( "click" );
            $("#analogs_list a.analog_remove").click(click_remove_button);
          };
        });
        $('#analogs_input .typeahead.tt-input').val('');
        $('#analogs_input .typeahead.tt-hint').val('');
        $('#analogs_input pre').html('');
      });
    };

    $('#analogs_list1_a').click(function () {
      recreate_analogs_list(1);
      recalc_analogs_progress_bars();

      this.style.display = "none";
      
      $("#analogs_list a.analog_confirm").unbind( "click" ); $("#analogs_list a.analog_confirm").click(click_add_button);
      $("#analogs_list a.analog_remove").unbind( "click" ); $("#analogs_list a.analog_remove").click(click_remove_button);
    });

});
