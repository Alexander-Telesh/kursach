var threshold1 = 500;
var threshold2 = 1500;
var content_width = 1270;

function initSideControls() {
  var control_min_width = $('.active-area').width();
  var window_width = $(window).width();
  var $bar_wrap = $('.leftbar-wrap');
  var $bar = $bar_wrap.find('.left-controlbar');
  var $scroll_back = $('#scroll-back');
  var prev_top = parseInt($scroll_back.attr('href').substr(1));

  var diff = window_width - content_width - (2 * control_min_width);
  if (diff<=0 && $(window).scrollTop()<document.getElementById("menubottomdiv").offsetTop+230) {
    $bar.hide();
    $bar_wrap.hide();
  } else{
    $bar.show();
    $bar_wrap.show();
    if ($(window).scrollTop() < threshold1) { $scroll_back.hide();$bar.hide();$bar_wrap.hide(); }

    var bar_width = (window_width - content_width) / 2;

    $bar_wrap.css({width: bar_width});

    if (!prev_top) $scroll_back.hide();

    $bar.off('click').on('click', function(e) {
      e.preventDefault();
      prev_top = $(window).scrollTop();
      $('html, body').animate({scrollTop: 0}, 'normal', function() {
        $scroll_back.attr('href', '#' + prev_top).css({display: 'block', opacity: 0}).animate({opacity: 1}, 'fast');
      });
    });
  }
}

$(document).ready(function() {
  var $scroll_back = $('#scroll-back');
  var $bar = $('.left-controlbar');
  var $bar_wrap = $('.leftbar-wrap');

  $(window)
    /* функция, которая управляет видимостью кнопки "Вверх" в зависимости от положения полос прокрутки */
    .scroll(function() {

      var content_width = 1270; //Здесь должна быть ширина вашего сайта (если верстка не резиновая).
      var window_width = $(window).width();
      var control_min_width = $('.active-area').width();

      var diff = window_width - content_width - (2 * control_min_width);
      if (diff<=0 && $(window).scrollTop()<document.getElementById("menubottomdiv").offsetTop+230) { 
        $bar.hide();
        $scroll_back.hide();
      } else 
      {
        var new_opacity = 1;
        if ($(window).scrollTop() < threshold1) { new_opacity = 0 }
        else if ($(window).scrollTop() < threshold2) { new_opacity = ($(window).scrollTop()-threshold1) / (threshold2-threshold1) };
        if (new_opacity) {
          $bar.show();
          $bar_wrap.show();
        } else {
          $bar.hide();
//          $bar_wrap.hide();
        }
        $bar.css({opacity: new_opacity});
        var offset = parseInt($scroll_back.attr('href').substr(1));
        if (new_opacity) {
          $scroll_back.hide();
        }
        else {
//          if (offset) $scroll_back.css({display: 'block', opacity: 0}).animate({opacity: 1}, 'fast');
        }
      }
    })
    .scroll()
    /* связываем событие изменения размеров окна браузера и функцию инициализации кнопок */
    .resize(initSideControls)
    .resize();
   
  /* функция для возврата пользователя на место, с которого он поднялся вверх */
  $scroll_back.click(function(e) {
    e.preventDefault();
    $('html, body').animate({scrollTop: $(this).attr('href').substr(1)}, 'normal');
    $(this).attr('href', '#0').hide();
  });
});