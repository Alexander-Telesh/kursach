/*
	Lightbox JS: Fullsize Image Overlays 
	by Lokesh Dhakar - http://www.huddletogether.com

	For more information on this script, visit:
	http://huddletogether.com/projects/lightbox/

	Script featured on Dynamic Drive code library Jan 24th, 06':
	http://www.dynamicdrive.com

	Licensed under the Creative Commons Attribution 2.5 License - http://creativecommons.org/licenses/by/2.5/
	(basically, do anything you want, just leave my name and link)
	
        Modification to the site fantlab.ru - Seifer

	Table of Contents
	-----------------
	Configuration
	
	Functions
	- getPageScroll()
	- getPageSize()
	- pause()
	- getKey()
	- listenKey()
	- showLightbox()
	- hideLightbox()
	- initLightbox()
	- addLoadEvent()
	
	Function Calls
	- addLoadEvent(initLightbox)
*/



//
// Configuration
//

// If you would like to use a custom loading image or close button reference them in the next two lines.
var loadingImage = '/img/loading.gif';

var MAX_RANDOM = 9999999;
var MIN_RANDOM = 1000000;		

var leftButton;
var rightButton;

//
// getPageScroll()
// Returns array with x,y page scroll values.
// Core code from - quirksmode.org
//
function getPageScroll(){

	var yScroll;

	if (self.pageYOffset) {
		yScroll = self.pageYOffset;
	} else if (document.documentElement && document.documentElement.scrollTop){	 // Explorer 6 Strict
		yScroll = document.documentElement.scrollTop;
	} else if (document.body) {// all other Explorers
		yScroll = document.body.scrollTop;
	}

	arrayPageScroll = new Array('',yScroll) 
	return arrayPageScroll;
}



//
// getPageSize()
// Returns array with page width, height and window width, height
// Core code from - quirksmode.org
// Edit for Firefox by pHaez
//
function getPageSize(){
	
	var xScroll, yScroll;
	
	if (window.innerHeight && window.scrollMaxY) {	
		xScroll = document.body.scrollWidth;
		yScroll = window.innerHeight + window.scrollMaxY;
	} else if (document.body.scrollHeight > document.body.offsetHeight){ // all but Explorer Mac
		xScroll = document.body.scrollWidth;
		yScroll = document.body.scrollHeight;
	} else { // Explorer Mac...would also work in Explorer 6 Strict, Mozilla and Safari
		xScroll = document.body.offsetWidth;
		yScroll = document.body.offsetHeight;
	}
	
	var windowWidth, windowHeight;
	if (self.innerHeight) {	// all except Explorer
		windowWidth = self.innerWidth;
		windowHeight = self.innerHeight;
	} else if (document.documentElement && document.documentElement.clientHeight) { // Explorer 6 Strict Mode
		windowWidth = document.documentElement.clientWidth;
		windowHeight = document.documentElement.clientHeight;
	} else if (document.body) { // other Explorers
		windowWidth = document.body.clientWidth;
		windowHeight = document.body.clientHeight;
	}	
	
	// for small pages with total height less then height of the viewport
	if(yScroll < windowHeight){
		pageHeight = windowHeight;
	} else { 
		pageHeight = yScroll;
	}

	// for small pages with total width less then width of the viewport
	if(xScroll < windowWidth){	
		pageWidth = windowWidth;
	} else {
		pageWidth = xScroll;
	}


	arrayPageSize = new Array(pageWidth,pageHeight,windowWidth,windowHeight) 
	return arrayPageSize;
}


//
// pause(numberMillis)
// Pauses code execution for specified time. Uses busy code, not good.
// Code from http://www.faqts.com/knowledge_base/view.phtml/aid/1602
//
function pause(numberMillis) {
	var now = new Date();
	var exitTime = now.getTime() + numberMillis;
	while (true) {
		now = new Date();
		if (now.getTime() > exitTime)
			return;
	}
}

//
// getKey(key)
// Gets keycode. If 'x' is pressed then it hides the lightbox.
//

function getKey(e){
        var keycode = (window.event) ? event.keyCode : e.which; // MSIE or Firefox?        
        var keycodeEsc = (window.event) ? event.keyCode : e.keyCode;
        var Esc = (window.event) ? 27 : e.DOM_VK_ESCAPE; // MSIE : Firefox
        var Left = (window.event) ? 37 : e.DOM_VK_LEFT;
		var Right = (window.event) ? 39 : e.DOM_VK_RIGHT;
	    key = String.fromCharCode(keycode).toLowerCase();
	    if(keycodeEsc == Esc || key == 'x' || key == 'ч' || key== 'х'){  hideLightbox(); }
		if((keycodeEsc == Left) && (leftButton.style.display == 'block')) { leftButton.click();  }
		if((keycodeEsc == Right) && (rightButton.style.display == 'block')) { rightButton.click(); }
}


//
// listenKey()
//
function listenKey () {	document.onkeypress = getKey; }
	

//
// showLightbox()
// Preloads images. Pleaces new image in lightbox then centers and displays.
//
function showLightbox(objLink)
{
	// prep objects
	var objOverlay = document.getElementById('overlay');
	var objLightbox = document.getElementById('lightbox');
	var objCaption = document.getElementById('lightboxCaption');
	var objImage = document.getElementById('lightboxImage');
	var objLoadingImage = document.getElementById('loadingImage');
	var objLightboxDetails = document.getElementById('lightboxDetails');

	
	var arrayPageSize = getPageSize();
	var arrayPageScroll = getPageScroll();	
	
	// center loadingImage if it exists
	if (objLoadingImage) {
		objLoadingImage.style.top = (arrayPageScroll[1] + ((arrayPageSize[3] - 35 - objLoadingImage.height) / 2) + 'px');
		objLoadingImage.style.left = (((arrayPageSize[0] - 20 - objLoadingImage.width) / 2) + 'px');
		objLoadingImage.style.display = 'block';
	}

	// set height of Overlay to take up whole page and show
	objOverlay.style.height = (arrayPageSize[1] + 'px');
	objOverlay.style.display = 'block';

	// preload image
	imgPreload = new Image();

	
	imgPreload.onload=function(){
		
			objImage.removeAttribute('width');
	objImage.removeAttribute('height');
		objImage.src = objLink.href;
		
		//модификация ссылки
		var originalLink = document.getElementById('originalLink');
		originalLink.href = objLink.href;
		originalLink.target = '_blank';
		originalLink.innerHTML = 'Оригинал (' + imgPreload.width + 'x' + imgPreload.height + ')';
		
		//увеличение изображения
		if (imgPreload.height + 50 > arrayPageSize[3] || imgPreload.width > arrayPageSize[2]) {			
			var image_new_height;
			var image_new_width;
			
			var proportion = imgPreload.width / imgPreload.height;			
			var image_new_height = arrayPageSize[3] - 120; //700
			var image_new_width = image_new_height * proportion;		
			
			objImage.width = image_new_width;
			objImage.height = image_new_height;
			imgPreload.width = image_new_width;
			imgPreload.height = image_new_height;
		}
		// center lightbox and make sure that the top and left values are not negative
		// and the image placed outside the viewport
		var lightboxTop = arrayPageScroll[1] + ((arrayPageSize[3] - 75 - imgPreload.height) / 2);
		var lightboxLeft = ((arrayPageSize[0] - 20 - imgPreload.width) / 2);
		
		objLightbox.style.top = (lightboxTop < 0) ? "0px" : lightboxTop + "px";
		objLightbox.style.left = (lightboxLeft < 0) ? "0px" : lightboxLeft + "px";


		objLightboxDetails.style.width = imgPreload.width + 'px';
		
		if(objLink.getAttribute('title')){
			objCaption.style.display = 'block';
			//objCaption.style.width = imgPreload.width + 'px';
			objCaption.innerHTML = objLink.getAttribute('title');
		} else {
			objCaption.style.display = 'none';
		}
		
		// A small pause between the image loading and displaying is required with IE,
		// this prevents the previous image displaying for a short burst causing flicker.
		if (navigator.appVersion.indexOf("MSIE")!=-1){
			pause(250);
		} 

		if (objLoadingImage) {	objLoadingImage.style.display = 'none'; }
		objLightbox.style.display = 'block';

		// After image is loaded, update the overlay height as the new image might have
		// increased the overall page height.
		arrayPageSize = getPageSize();
		objOverlay.style.height = (arrayPageSize[1] + 'px');
		
		// Check for 'x' keypress
		listenKey();

		return false;
	}

	imgPreload.src = objLink.href;
}





//
// hideLightbox()
//
function hideLightbox()
{
	// get objects
	objOverlay = document.getElementById('overlay');
	objLightbox = document.getElementById('lightbox');

	// hide lightbox and overlay
	objOverlay.style.display = 'none';
	objLightbox.style.display = 'none';
	
	// disable keypress listener
	document.onkeypress = '';
}




//
// initLightbox()
// Function runs on window load, going through link tags looking for rel="lightbox".
// These links receive onclick events that enable the lightbox display for their targets.
// The function also inserts html markup at the top of the page which will be used as a
// container for the overlay pattern and the inline image.
//
function initLightbox()
{
	var pointer;
	var group_pointer;
	
	if (!document.getElementsByTagName){ return; }
	var anchors = document.getElementsByTagName("a");

	var imageLinkArray = new Array();
	var k = new Array();
	 
	var groupName;

	// loop through all anchor tags
	for (var i=0; i<anchors.length; i++){
		var anchor = anchors[i];
		if (anchor.getAttribute("href") && (anchor.rel.indexOf("lightbox") > -1)) {

			//get name of the group
			groupName = anchor.rel.match(/\[\S*\]/);
			if (groupName == null) {
				groupName = Math.floor(Math.random() * (MAX_RANDOM - MIN_RANDOM + 1)) + MIN_RANDOM;
			}
			anchor.rel = groupName;			
			if (imageLinkArray[groupName] == null) {
				imageLinkArray[groupName] = new Array();
			}
			if (k[groupName] == null) { k[groupName] = 0; }
			imageLinkArray[groupName][k[groupName]] = anchor;
						 
			anchor.setAttribute('rev',k[groupName]++);
			anchor.onclick = function () {	
			    
			    pointer = this.getAttribute('rev');		
				groupPointer = this.getAttribute('rel');
				
				var startPointer = parseInt(this.getAttribute('rev'));
								
				pagerDiv.innerHTML = pagerText(startPointer, imageLinkArray[groupPointer].length);
				if (startPointer == 0) {
					leftButton.style.display = 'none';					
				}
				else {
					leftButton.style.display = 'block';
				}
				if (startPointer == imageLinkArray[groupPointer].length-1) {
					rightButton.style.display = 'none';
					objLink.onclick = function(){
						hideLightbox();
						return false;
					}
				}
				else {
					rightButton.style.display = 'block';
					objLink.onclick = function(){
						rightButton.click();
						return false;
					}
				}	
				if ((rightButton.style.display == 'none') && (leftButton.style.display == 'none'))
					pagerDiv.style.display = 'none';
					else
					pagerDiv.style.display = 'block';			
				showLightbox(this); return false;};				
		}
	}

	// the rest of this code inserts html at the top of the page that looks like this:
	//
	// <div id="overlay">
	//		<a href="#" onclick="hideLightbox(); return false;"><img id="loadingImage" /></a>
	//	</div>
	// <div id="lightbox">
	//		<a href="#" onclick="hideLightbox(); return false;" title="Click anywhere to close image">
	//			<img id="closeButton" />		
	//			<img id="lightboxImage" />
	//		</a>
	//		<div id="lightboxDetails">
	//			<div id="lightboxCaption"></div>
	//			<div id="keyboardMsg"></div>
	//		</div>
	// </div>
	
	var objBody = document.getElementsByTagName("body").item(0);
	
	// create overlay div and hardcode some functional styles (aesthetic styles are in CSS file)
	var objOverlay = document.createElement("div");
	objOverlay.setAttribute('id','overlay');
	objOverlay.onclick = function () {hideLightbox(); return false;}
	objOverlay.style.display = 'none';
	objOverlay.style.position = 'absolute';
	objOverlay.style.top = '0';
	objOverlay.style.left = '0';
	objOverlay.style.zIndex = '90';
 	objOverlay.style.width = '100%';
	objBody.insertBefore(objOverlay, objBody.firstChild);
	
	var arrayPageSize = getPageSize();
	var arrayPageScroll = getPageScroll();

	// preload and create loader image
	var imgPreloader = new Image();
	
	// if loader image found, create link to hide lightbox and create loadingimage
	imgPreloader.onload=function(){

		var objLoadingImageLink = document.createElement("a");
		objLoadingImageLink.setAttribute('href','#');
		objLoadingImageLink.onclick = function () {hideLightbox(); return false;}
		objOverlay.appendChild(objLoadingImageLink);
		
		var objLoadingImage = document.createElement("img");
		objLoadingImage.src = loadingImage;
		objLoadingImage.setAttribute('id','loadingImage');
		objLoadingImage.style.position = 'absolute';
		objLoadingImage.style.zIndex = '150';
		objLoadingImageLink.appendChild(objLoadingImage);

		imgPreloader.onload=function(){};	//	clear onLoad, as IE will flip out w/animated gifs

		return false;
	}

	imgPreloader.src = loadingImage;

	// create lightbox div, same note about styles as above
	var objLightbox = document.createElement("div");
	objLightbox.setAttribute('id','lightbox');
	objLightbox.style.display = 'none';
	objLightbox.style.position = 'absolute';
	objLightbox.style.zIndex = '100';	
	objBody.insertBefore(objLightbox, objOverlay.nextSibling);

        var objContainer = document.createElement('div');	
	objContainer.style.textAlign = 'right';
	objContainer.style.marginBottom = '3px';
	objLightbox.appendChild(objContainer);
/*
	var closeLink = document.createElement('a');
	closeLink.title = 'Закрыть окно';
	closeLink.href = '#';
	closeLink.innerHTML = '<small style="color:black">закрыть [x]</small>';	
	closeLink.onclick = function () {hideLightbox(); return false;}
	objContainer.appendChild(closeLink);
*/	
	// create link	
	var objLink = document.createElement("a");
	objLink.setAttribute('href','#');
	objLightbox.appendChild(objLink);

//	// preload and create close button image
//	var imgPreloadCloseButton = new Image();
//
//	// if close button image found, 
//	imgPreloadCloseButton.onload=function(){
//
//		var objCloseButton = document.createElement("img");
//		objCloseButton.src = closeButton;
//		objCloseButton.setAttribute('id','closeButton');
//		objCloseButton.style.position = 'absolute';
//		objCloseButton.style.zIndex = '200';
//		objLink.appendChild(objCloseButton);
//
//		return false;
//	}
//
//	imgPreloadCloseButton.src = closeButton;

	// create image
	var objImage = document.createElement("img");
	objImage.setAttribute('id','lightboxImage');
	objLink.appendChild(objImage);
		
	// create details div, a container for the caption and keyboard message
	var objLightboxDetails = document.createElement("div");
	objLightboxDetails.setAttribute('id','lightboxDetails');
	objLightbox.appendChild(objLightboxDetails);
	
	var detailsTable = document.createElement('table');
	detailsTable.style.width='100%';
	var tableRow = document.createElement('tr');
	tableRow.style.height = '100%';
	
	var leftButtonCell = document.createElement('td');
	leftButtonCell.style.width='40px';
	leftButtonCell.style.height='100%';
	var middleCell = document.createElement('td');
	var rightButtonCell = document.createElement('td');
	rightButtonCell.style.width='40px';
	rightButtonCell.style.height='100%';
	
	objLightboxDetails.appendChild(detailsTable);
	detailsTable.appendChild(tableRow);
	tableRow.appendChild(leftButtonCell);
	tableRow.appendChild(middleCell);
	tableRow.appendChild(rightButtonCell);

	// create caption
	var objCaption = document.createElement("div");
	objCaption.setAttribute('id','lightboxCaption');
	middleCell.appendChild(objCaption);
		
	//create left-button
	leftButton = document.createElement('input');
	leftButton.setAttribute('type','image');
	leftButton.value = '<<';
	leftButton.src = '/img/arrow_left.png';	
	
	leftButton.onclick = function(){		
		pointer--;		
		if (pointer == 0) {
			
			leftButton.style.display = 'none';
			rightButton.style.display = 'block';
		}
		else {
			rightButton.style.display = 'block';
			objLink.onclick = function(){
				rightButton.click();
				return false;
			}
		}
		showLightbox(imageLinkArray[groupPointer][pointer]);
		pagerDiv.innerHTML = pagerText(pointer, imageLinkArray[groupPointer].length);		
	}
	leftButtonCell.appendChild(leftButton);
	
	//create right-button
	rightButton = document.createElement('input');
	rightButton.setAttribute('type','image');
	rightButton.value = '>>';
	rightButton.src = '/img/arrow_right.png';
	
	rightButton.onclick = function(){
		++pointer;
		if (pointer >= imageLinkArray[groupPointer].length - 1) {
			rightButton.style.display = 'none';
			objLink.onclick = function(){
				hideLightbox();
				return false;
			}
			leftButton.style.display = 'block';
		}
		else {
			leftButton.style.display = 'block';
			
		}
		showLightbox(imageLinkArray[groupPointer][pointer]);
		pagerDiv.innerHTML = pagerText(pointer, imageLinkArray[groupPointer].length);
	}
	rightButtonCell.appendChild(rightButton);
	
	//
	var pagerDiv = document.createElement('div');
	pagerDiv.style.paddingTop = '5px';
	pagerDiv.style.textAlign = 'center';
	middleCell.appendChild(pagerDiv);

	// create link element to the original image
	var originalLinkDiv = document.createElement('div');
	originalLinkDiv.innerHTML = '<a id="originalLink" />';
	originalLinkDiv.style.paddingTop = '5px';
	originalLinkDiv.style.textAlign = 'center';    
	middleCell.appendChild(originalLinkDiv);
}

function pagerText(currentPage, allPages) {
	return 'Показано ' + (currentPage+1) + ' из ' + allPages + ' изображений';	
}

//
// addLoadEvent()
// Adds event to window.onload without overwriting currently assigned onload functions.
// Function found at Simon Willison's weblog - http://simon.incutio.com/
//
function addLoadEvent(func)
{	
	var oldonload = window.onload;
	if (typeof window.onload != 'function'){
    	window.onload = func;
	} else {
		window.onload = function(){
		oldonload();
		func();
		}
	}
}

addLoadEvent(initLightbox);	// run initLightbox onLoad