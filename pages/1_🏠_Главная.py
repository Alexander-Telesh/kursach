"""–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –æ–±—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–µ—Ä–∏–∏ –∏ –æ—Ç–∑—ã–≤–∞–º–∏."""
import streamlit as st
from database.repository_supabase import BookRepositorySupabase, ReviewRepositorySupabase
from database.helpers import dicts_to_books, dicts_to_reviews
from services.fantlab_api import sync_reviews_from_fantlab, FantLab
from datetime import datetime

st.title("üè† –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞")
st.markdown("---")

# –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∫–Ω–∏–≥–∞—Ö
books_data = BookRepositorySupabase.get_all()
books = dicts_to_books(books_data)

# –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–∏–∏
st.header("üìñ –û —Å–µ—Ä–∏–∏ '–°—Ç–µ–ª–ª–∞—Ä'")

# –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ü–∏–∫–ª–µ —Å FantLab (–µ—Å–ª–∏ –µ—Å—Ç—å series_id)
series_id = None
series_info = None

if books_data:
    # –ò—â–µ–º series_id –≤–æ –≤—Å–µ—Ö –∫–Ω–∏–≥–∞—Ö
    for book in books_data:
        series_id = book.get("fantlab_series_id")
        if series_id:
            break
    
    if series_id:
        try:
            api = FantLab()
            series_info = api.get_series_info(series_id)
            
            if "error" not in series_info:
                # –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è —Ü–∏–∫–ª–∞
                if series_info.get("annotation"):
                    st.markdown(series_info["annotation"])
                else:
                    st.markdown("""
                    –°–µ—Ä–∏—è –∫–Ω–∏–≥ "–°—Ç–µ–ª–ª–∞—Ä" - —ç—Ç–æ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∞—è —Å–∞–≥–∞, –∫–æ—Ç–æ—Ä–∞—è –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —á–∏—Ç–∞—Ç–µ–ª–µ–π 
                    —Å–≤–æ–∏–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –º–∏—Ä–æ–º –∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏. –ó–¥–µ—Å—å –≤—ã –Ω–∞–π–¥–µ—Ç–µ –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–∞—Ö —Å–µ—Ä–∏–∏, 
                    –æ—Ç–∑—ã–≤—ã —á–∏—Ç–∞—Ç–µ–ª–µ–π –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –æ–Ω–ª–∞–π–Ω.
                    """)
            else:
                st.markdown("""
                –°–µ—Ä–∏—è –∫–Ω–∏–≥ "–°—Ç–µ–ª–ª–∞—Ä" - —ç—Ç–æ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∞—è —Å–∞–≥–∞, –∫–æ—Ç–æ—Ä–∞—è –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —á–∏—Ç–∞—Ç–µ–ª–µ–π 
                —Å–≤–æ–∏–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –º–∏—Ä–æ–º –∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏. –ó–¥–µ—Å—å –≤—ã –Ω–∞–π–¥–µ—Ç–µ –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–∞—Ö —Å–µ—Ä–∏–∏, 
                –æ—Ç–∑—ã–≤—ã —á–∏—Ç–∞—Ç–µ–ª–µ–π –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –æ–Ω–ª–∞–π–Ω.
                """)
        except:
            st.markdown("""
            –°–µ—Ä–∏—è –∫–Ω–∏–≥ "–°—Ç–µ–ª–ª–∞—Ä" - —ç—Ç–æ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∞—è —Å–∞–≥–∞, –∫–æ—Ç–æ—Ä–∞—è –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —á–∏—Ç–∞—Ç–µ–ª–µ–π 
            —Å–≤–æ–∏–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –º–∏—Ä–æ–º –∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏. –ó–¥–µ—Å—å –≤—ã –Ω–∞–π–¥–µ—Ç–µ –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–∞—Ö —Å–µ—Ä–∏–∏, 
            –æ—Ç–∑—ã–≤—ã —á–∏—Ç–∞—Ç–µ–ª–µ–π –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –æ–Ω–ª–∞–π–Ω.
            """)
    else:
        st.markdown("""
        –°–µ—Ä–∏—è –∫–Ω–∏–≥ "–°—Ç–µ–ª–ª–∞—Ä" - —ç—Ç–æ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∞—è —Å–∞–≥–∞, –∫–æ—Ç–æ—Ä–∞—è –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —á–∏—Ç–∞—Ç–µ–ª–µ–π 
        —Å–≤–æ–∏–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –º–∏—Ä–æ–º –∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏. –ó–¥–µ—Å—å –≤—ã –Ω–∞–π–¥–µ—Ç–µ –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–∞—Ö —Å–µ—Ä–∏–∏, 
        –æ—Ç–∑—ã–≤—ã —á–∏—Ç–∞—Ç–µ–ª–µ–π –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –æ–Ω–ª–∞–π–Ω.
        """)
else:
    st.markdown("""
    –°–µ—Ä–∏—è –∫–Ω–∏–≥ "–°—Ç–µ–ª–ª–∞—Ä" - —ç—Ç–æ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∞—è —Å–∞–≥–∞, –∫–æ—Ç–æ—Ä–∞—è –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —á–∏—Ç–∞—Ç–µ–ª–µ–π 
    —Å–≤–æ–∏–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –º–∏—Ä–æ–º –∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏. –ó–¥–µ—Å—å –≤—ã –Ω–∞–π–¥–µ—Ç–µ –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–∞—Ö —Å–µ—Ä–∏–∏, 
    –æ—Ç–∑—ã–≤—ã —á–∏—Ç–∞—Ç–µ–ª–µ–π –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –æ–Ω–ª–∞–π–Ω.
    """)

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å FantLab
st.header("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å FantLab")

# –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –ø–æ–ª—É—á–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ü–∏–∫–ª–µ
if series_id and series_info and "error" not in series_info:
    col1, col2, col3 = st.columns(3)
    
    with col1:
        series_rating = series_info.get("rating", 0.0)
        if series_rating > 0:
            st.metric("‚≠ê –†–µ–π—Ç–∏–Ω–≥ —Ü–∏–∫–ª–∞", f"{series_rating:.2f}")
        else:
            st.metric("‚≠ê –†–µ–π—Ç–∏–Ω–≥ —Ü–∏–∫–ª–∞", "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö")
    
    with col2:
        series_reviews_count = series_info.get("reviews_count", 0)
        st.metric("üìù –û—Ç–∑—ã–≤–æ–≤ –Ω–∞ —Ü–∏–∫–ª", series_reviews_count)
    
    with col3:
        works_count = len(series_info.get("works", []))
        if works_count > 0:
            st.metric("üìö –ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π –≤ —Ü–∏–∫–ª–µ", works_count)
        else:
            st.metric("üìö –ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π –≤ —Ü–∏–∫–ª–µ", len(books) if books else 0)
elif series_id:
    st.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å FantLab. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ series_id.")
elif books_data:
    st.info("–î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å FantLab –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å fantlab_series_id –¥–ª—è –∫–Ω–∏–≥.")
else:
    st.info("–ù–µ—Ç –∫–Ω–∏–≥ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")

st.markdown("---")

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–æ–≤
st.header("üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å FantLab")

col1, col2 = st.columns([3, 1])

with col1:
    st.info("–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å —Ä–µ—Å—É—Ä—Å–∞ FantLab.ru. –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.")

with col2:
    if st.button("üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏.", type="primary"):
        with st.spinner("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏..."):
            try:
                result = sync_reviews_from_fantlab()
                if result.get("success"):
                    total_reviews = result.get('total_reviews', 0)
                    updated_books = result.get('updated_books', 0)
                    st.success(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ {total_reviews} –æ—Ç–∑—ã–≤–æ–≤ –¥–ª—è {updated_books} –∫–Ω–∏–≥")
                    if result.get('series_rating'):
                        st.info(f"‚≠ê –û—Ü–µ–Ω–∫–∞ —Ü–∏–∫–ª–∞: {result.get('series_rating', 0):.2f}")
                    st.rerun()
                else:
                    error_msg = result.get('error', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')
                    st.error(f"‚ùå –û—à–∏–±–∫–∞: {error_msg}")
                    st.info("üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —É –∫–Ω–∏–≥ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã fantlab_work_id –∏ fantlab_series_id")
            except Exception as e:
                st.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {str(e)}")
                import traceback
                st.code(traceback.format_exc())

st.markdown("---")

# –°—Å—ã–ª–∫–∏ –Ω–∞ –æ—Ç–∑—ã–≤—ã –Ω–∞ FantLab
st.header("üí¨ –û—Ç–∑—ã–≤—ã –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏")

# –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ü–∏–∫–ª–µ –¥–ª—è —Å—Å—ã–ª–∫–∏
if books_data:
    series_id = None
    for book in books_data:
        series_id = book.get("fantlab_series_id")
        if series_id:
            break
    
    if series_id:
        fantlab_series_url = f"https://fantlab.ru/work/{series_id}#responses"
        st.info(f"üìù –û—Ç–∑—ã–≤—ã –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Ü–∏–∫–ª—É '–°—Ç–µ–ª–ª–∞—Ä' –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ FantLab.ru")
        st.markdown(f"[üîó –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ç–∑—ã–≤–∞–º –Ω–∞ —Ü–∏–∫–ª –Ω–∞ FantLab.ru]({fantlab_series_url})")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤ –Ω–∞ —Ü–∏–∫–ª
        try:
            api = FantLab()
            series_info = api.get_series_info(series_id)
            if "error" not in series_info:
                series_reviews_count = series_info.get("reviews_count", 0)
                if series_reviews_count > 0:
                    st.success(f"‚úÖ –ù–∞ FantLab.ru –Ω–∞–π–¥–µ–Ω–æ {series_reviews_count} –æ—Ç–∑—ã–≤–æ–≤ –Ω–∞ —Ü–∏–∫–ª")
                else:
                    st.info("‚ÑπÔ∏è –ù–∞ FantLab.ru –ø–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤ –∫ —ç—Ç–æ–º—É —Ü–∏–∫–ª—É")
        except Exception:
            pass
    else:
        st.warning("‚ö†Ô∏è –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Ç–∑—ã–≤–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å fantlab_series_id –¥–ª—è –∫–Ω–∏–≥.")
else:
    st.info("‚ÑπÔ∏è –ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")
