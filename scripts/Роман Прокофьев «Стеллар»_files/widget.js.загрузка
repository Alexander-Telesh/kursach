var pr_m;
var pr_e;
var selector;
var is_w;
var cur_work;
var show_spec_flag;
var has_spec_mark;  // флаг о том, выставлена ли уже спецотметка вместо цифровой оценки
var nav = (navigator.appName != 'Microsoft Internet Explorer');
//var nav = true;

function setMark(el)
{
	var pr_e_l = pr_e;
	var el_l = el;
	var c_w_l = cur_work;

    // удаление спецотметок при выставленной, вызываем при выборе минуса свою функцию setSpecialMark для этого и выходим из этой
    if (el.innerHTML == "-" && has_spec_mark) {
        setSpecialMark("delete", (show_spec_flag == "mainblock" ? cur_work : 0));
        selector.style.visibility = "hidden";
        return;
    }

	setGraph(el);
	selector.style.visibility = "hidden";
	if (pr_e.className != "selector")
		pr_e.style.borderColor = "";
	if (pr_e.innerHTML == el.innerHTML) {
		return;
	}
	else {
		pr_e.innerHMTL = el.innerHMTL;
	}

    var mark_link = "/work"+cur_work+"/ajaxsetmark"+(el.innerHTML=='-' ? '0' : el.innerHTML)+"towork"+cur_work;
    pr_e.innerHTML = "<img src='/img/loading_mark.gif' style='vertical-align:middle;' height="+(pr_e_l.className == "selector" ? "16" : "14")+" border=0 alt='&infin;'>";
    $.ajax({
        url: mark_link,
        success: function (json) {
            var r_str = (json.markcount == 0 ? "" : json.midmark + " (" + json.markcount + ")");
            if (pr_e_l.className == "author_mark")
            {
                var elems = document.getElementsByTagName('span');
                for (i=0, max = elems.length; i<max; i++) {
                    if (elems[i].id == 'm_'+c_w_l) {
                        elems[i].innerHTML = r_str;
                        if (elems[i].parentNode.parentNode.parentNode.childNodes[3].childNodes[0].childNodes[0]) {
                          //elems[i].parentNode.parentNode.parentNode.childNodes[3].childNodes[0].childNodes[0].innerHTML = el_l.innerHTML;
                          //$("#work_mark"+cur_work).html(el_l.innerHTML);
                          $(elems[i].parentNode.parentNode.parentNode).find(".author_mark").html(el_l.innerHTML);
                        } else {
                          $("#analog_work_mark"+cur_work).html(el_l.innerHTML);
                        };
                    }
                }
                pr_e.innerHTML = el_l.innerHTML;
            }
            else if (pr_e_l.className == "bookcase_mark") {
                var l = document.getElementById('m_'+c_w_l);
                if (l) l.innerHTML = r_str;
                pr_e_l.innerHTML = el_l.innerHTML;
            }
            else {
                document.getElementById('m_c_'+c_w_l).innerHTML = json.markcount;
                document.getElementById('m_m_'+c_w_l).innerHTML = json.midmark;
                pr_e_l.innerHTML = el_l.innerHTML;
                $("[id^='button_']").removeClass("spec_mark_selected");
                $("[id^='button_']").removeClass("spec_mark_unselected");
            }
            // пересчёт и отображения прочитанного с новой оценкой для режима оценивания на страницах изданий
            if (isMarkMode) {
                calculateCompleteStatus(cur_work);
            }
        }
    });

    if (document.getElementById('votelinkdiv') && (selector.parentNode.className != "amblock") && window.location.pathname == "/work"+cur_work)
    {
      document.getElementById('votelinkdiv').style.display = (el.innerHTML=='-' ? 'none' : 'inline-block');
      document.getElementById('work-classif-unit').style.display = 'block';
    }
}
// переключает список оценок между списком цифровых и спецотметками, action == 'show' - показать спецотметки для оценивания
function displayOtherMarks(action) {
    // для основного блока рейтинга страницы ворка
    if (action == "mainblock") {
        $("#special_marks_group").css("display","flex");
        selector.style.visibility = "hidden";
    // для прочих списков
    } else {
        var digMarkUnits = selector.querySelectorAll('.dig-mark-unit');
        for (var i = 0; i < digMarkUnits.length; i++) {
            digMarkUnits[i].style.display = (action === 'show' ? 'none' : 'block');
        }
        var specMarkUnits = selector.querySelectorAll('.spec-mark-unit');
        for (var j = 0; j < specMarkUnits.length; j++) {
            specMarkUnits[j].style.display = (action === 'show' ? 'block' : 'none');
        }
    }
}    
// выставление специальных отметок на разных страницах    
function setSpecialMark(mark, workId) {
    var isWorkPage = true; // определяем, запускать интерфейс для страницы отдельного ворка или для списков ворков
    if (!workId) {
        workId = cur_work;
        isWorkPage = false;
    }
    // эффект нажатия на иконку
    if (isWorkPage) {
        $("#button_" + mark).addClass("button-click-effect");
    }
    var originalMark = mark;
    // если был клик по уже выбранной отметке, значит её нужно будет удалить
    if (isWorkPage && $("#button_" + mark).hasClass("spec_mark_selected")) {
        mark = 'delete';
    }
    var markLink = '/work' + workId + '/ajaxspecmark/' + mark;
    if (!isWorkPage) {
        var pr_e_l = pr_e;
        selector.style.visibility = "hidden";
        if (pr_e.className != "selector") {
            pr_e.style.borderColor = ""; 
        }
        pr_e.innerHTML = "<img src='/img/loading_mark.gif' style='vertical-align:middle;' height="+(pr_e_l.className == "selector" ? "16" : "14")+" border=0 alt='&infin;'>";
    }
    $.ajax({
        url: markLink,
        success: function (json) {
            $("[id^='button_']").removeClass("spec_mark_selected");
            if (mark != 'delete') {
                if (isWorkPage) {
                    $("[id^='button_']").addClass("spec_mark_unselected");
                    $("#button_" + mark).removeClass("spec_mark_unselected").addClass("spec_mark_selected");
                    $("#mark_sel").html("-");
                } else {
                    pr_e.innerHTML = "<img src='/img/"+mark+"_icon24.png' height='14'>";
                }
            } else {
                if (isWorkPage) {
                    $("[id^='button_']").removeClass("spec_mark_unselected");
                } else {
                    pr_e.innerHTML = "-";
                }
            }
            if (isMarkMode) {
                calculateCompleteStatus(workId);
            }
        },
        complete: function () {
            if (isWorkPage) {
                $("#button_" + originalMark).removeClass("button-click-effect");
            }
        }
    });
}

function getWidget()
{
    var img = new Image;
	img.src="/img/loading_mark.gif";
	selector = document.getElementById('sel');
	if (selector==null)
	{
		selector = document.createElement('div');
		selector.id = 'sel';
		selector.className = 'selector';
		selector.style.visibility = 'hidden';
		selector.style.position = 'absolute';
		selector.onmouseover = function () { is_w = true; }
		selector.onmouseout = function () { is_w = false; }
		document.getElementsByTagName('body')[0].appendChild(selector);
		selector.innerHTML = "<div id=\"me_-\" class=\"mark dig-mark-unit\" onclick=\"setMark(this);\">-</div>";
		for (i = 1; i < 11; i++) {
			selector.innerHTML += "<div id=\"me_"+i+"\" class=\"mark dig-mark-unit\" onclick=\"setMark(this);\">"+i+"</div>";
		}
        selector.innerHTML += '<div id="me_o" class="mark dig-mark-unit" title="дополнительно" onclick="displayOtherMarks(show_spec_flag);">+</div>';
        selector.innerHTML += '<div id="me_back" class="mark spec-mark-unit" title="назад" onclick="displayOtherMarks(\'hide\');">&#9668;</div>';
        selector.innerHTML += '<div id="me_finish" class="spec-mark-unit" style="display: none; cursor: pointer;" title="прочитано" onclick="setSpecialMark(\'finish\', 0);"><img src="/img/finish_icon24.png" style="margin: 3px 0px;" height="14"></div>';
        selector.innerHTML += '<div id="me_unfinish" class="spec-mark-unit" style="display: none; cursor: pointer;" title="недочитано" onclick="setSpecialMark(\'unfinish\', 0);"><img src="/img/unfinish_icon24.png" style="margin: 3px 0px;" height="14"></div>';
        selector.innerHTML += '<div id="me_want" class="spec-mark-unit" style="display: none; cursor: pointer;" title="хочу прочитать" onclick="setSpecialMark(\'want\', 0);"><img src="/img/want_icon24.png" style="margin: 3px 0px;" height="14"></div>';
        selector.innerHTML += '<div id="me_dontwant" class="spec-mark-unit" style="display: none; cursor: pointer;" title="не хочу читать" onclick="setSpecialMark(\'dontwant\', 0);"><img src="/img/dontwant_icon24.png" style="margin: 3px 0px;" height="14"></div>';
	}
}

function setGraph(el)
{
	if (pr_m != null) {
		pr_m.style.backgroundColor = "";
		pr_m.style.color = "black";
	}
	el.style.backgroundColor = "#3178A8";
	el.style.color = "white";
	pr_m = el;
}
function selShow(el,work_id) {

    // для незарегистрированных - показываем алерт
    if (window.fl_auth == undefined) { regShow(); return; }
    // если оценка выставляется из блока рейтинга ворка, то нужно переключить интерфейс    
    if (el.id == "mark_sel") {
        show_spec_flag = "mainblock";
        has_spec_mark = ( !!document.querySelector('#special_marks_group .spec_mark_selected') ? true : false );
    } else {
        show_spec_flag = "show";
        has_spec_mark = ( el.querySelector("img") ? true : false );
    }

    var shown = selector.style.visibility;		
	if (shown == "hidden" || (shown=="visible" && pr_e != el)) {
		cur_work = work_id;
		is_w = true;
		var style;

		if (nav) {
		 
			style = window.getComputedStyle(el,null);
			}
		else {
			style = el.currentStyle;
			selector.parentNode.style.zIndex = "0";
			el.parentNode.style.zIndex = "1";		
		}
        displayOtherMarks('hide');
		selector.parentNode.removeChild(selector);		
		el.parentNode.appendChild(selector);		
		selector.style.left = el.offsetLeft + "px"; 
		selector.style.width = parseInt(style.width) + parseInt(style.paddingRight) + "px";
		selector.style.top = el.offsetTop + parseInt(style.height) + 3 + "px";
		selector.style.visibility = "visible";
		if (pr_e != null && el.className != "selector")
		pr_e.style.borderColor = "";
		el.style.borderColor = "#3178A8";				
		pr_e = el;			
		setGraph(document.getElementById("me_"+el.innerHTML));
	} 
	else
	{
		selector.style.visibility = "hidden";
		is_w = false;
		if (pr_e.className != "selector")
			pr_e.style.borderColor = "";	
	}
}

function regShow()
{
   if (confirm("Голосование доступно только зарегистрированным посетителям. Перейти на страницу регистрации?")) { document.location.href="/regform" }
}


function PmEditPopupfillForm(popup, name, friend_id, data) {
    popup.find('.pm-name').text(name);
    popup.find(':input[name=friend_id]').val(friend_id);
    popup.find(':input[name=user_name]').val(name);

    popup.find(':input[name=alt_name]').val(data.alt_name || name);
    popup.find(':input[name=group_name]').val(data.group_name);
    popup.find(':input[name=comment]').val(data.comment);
}

function OpenPmEditPopup(footer_sel, name, friend_id, link) {
    var footer = $(footer_sel);
    var popup = $("#pm_edit_popup");
    popup.find('.popup-footer').html(footer.html());
    popup.find('form').attr('action', $(link).attr('href'));
    popup.find('form').off('submit');
    var data = $(link).data();
    if(data.edit) {
        popup.find('.remove').data('friend_id',friend_id);
        PmEditPopupfillForm(popup, name, friend_id, data);
        popup.find('form').on('submit', PmUpdateContactInfo);
    }
    else {
        PmEditPopupfillForm(popup, name, friend_id, {});
        popup.find('form').on('submit', PmAddContactInfo);
    }

    // 
    if(popup.parent()[0].tagName !== 'body' && popup.parent()[0].tagName !== 'BODY') {
        var p = popup.detach();
        $('body').append(p);
    }
    // make popup centered (jquery way)
    //var left = $('.left-sidebar').offset().left + 240;
    var top = $(document).scrollTop() + $(window).height()/2 - 120;
    popup.css({ 'top': top + 'px', 'left': '30%' });

    // show popup
    popup.css("visibility","visible");
    // focus
    if(link && $(link).hasClass('pm-iconbutton-c')) {
        popup.find(':input[name=comment]').focus();
    }
    else {
        popup.find(':input[name=alt_name]').focus();
    }
    // закрытие попапа по Esc
    $(document).on('keyup.popup', function(e) {
        if (e.keyCode == 27) {
            ClosePmEditPopup();
        }
    });
    $("#pm_edit_popup .dropdown-menu").on('click', 'a', function(e) {
        e.preventDefault();
        popup.find(':input[name=group_name]').val($(this).data('name'));
    });
    $('.dropdown-toggle').dropdown();
    return false;
}

// common function to close popup
function ClosePmEditPopup() {
    $(document).off('keyup.popup');
    $("#pm_edit_popup .dropdown-menu").off('click', 'a');
    $("#pm_edit_popup").css("visibility","hidden");
}

function PmUpdateContactInfo(e) {
    e.preventDefault();
    var form = $(e.target);
    $.post(form.attr('action'), form.serialize(), function(r) {
        if(r.ok) {
            ClosePmEditPopup();
            UpdatePmGroupsDropDown( form.find(':input[name=group_name]').val() );
            // обновим блок "личная переписка"
            if(r.postaction) $.get(r.postaction, function(html) {
                $('#notice-base').html(html);
                $('#notice-base .pm-iconbutton-c').tooltip();
            });
        }
        else if(r.errors) {
            alert("Ошибки при сохранении:\n" + r.errors.join("\n"));
        }
    });
}

function PmDeleteContact(e) {
    var friend_id = $(e).data('friend_id');
    if(!friend_id) return false;
    if(!confirm('Удалить контакт ?')) return false;
    $.post('/user' + friend_id + '/deletefromfriends', {}, function(r) {
        ClosePmEditPopup();
        // если находимся на странице пользователя, то покажем кнопку "добавить" и спрячем кнопку "удалить"
        $('#p_user_delete_contact').hide();
        $('#p_user_add_contact').show();
        // обновим блок "личная переписка"
        if(r.postaction) $.get(r.postaction, function(html) {
            $('#notice-base').html(html);
            $('#notice-base .pm-iconbutton-c').tooltip();
        });
    });
}

function PmAddContactInfo(e) {
    e.preventDefault();
    var form = $(e.target);
    $.post(form.attr('action'), form.serialize(), function(r) {
        if(r.ok) {
            ClosePmEditPopup();
            UpdatePmGroupsDropDown( form.find(':input[name=group_name]').val() );
            // если находимся на странице пользователя, то спрячем кнопку "добавить" и покажем кнопку "удалить"
            $('#p_user_delete_contact').show();
            $('#p_user_add_contact').hide();
            // если есть в неавторизованных, то спрячем
            $('li#na' + form.find(':input[name=friend_id]').val()).hide();
            if($('#notice-noauth li').is(':hidden')) {
                $('#notice-base + .pm-hr').hide();
                $('#notice-noauth').hide();
            }
            // обновим блок "личная переписка"
            if(r.postaction) $.get(r.postaction, function(html) {
                $('#notice-base').html(html);
                $('#notice-base .pm-iconbutton-c').tooltip();
            });
        }
        else if(r.errors) {
            alert("Ошибки при сохранении:\n" + r.errors.join("\n"));
        }
    });
}

function UpdatePmGroupsDropDown(group_name) {
    if(! group_name) return;
    var exists = false;
    $('.dropdown-menu li').each(function(i,e) {
        if($(e).text() === group_name) exists = true;
    });
    if(! exists) {
        var a = $('<a>', { 'data-name': group_name, href: '' }).text(group_name);
        var li = $('<li>').append(a);
        $('.dropdown-menu').append(li);
    }
}

function GetRandomWork() {
    $.ajax({ url: "/getrandomwork", success: function(data) { document.getElementById("randomworkcontent").innerHTML = data; return false; } });
}

function SwitchRandomWorkGenre(genre) {
    if (random_scif.checked && !random_myst.checked && !random_fant.checked && !random_real.checked && !random_dtct.checked) { random_scif.disabled = true } else
    if (!random_scif.checked && random_myst.checked && !random_fant.checked && !random_real.checked && !random_dtct.checked) { random_myst.disabled = true } else
    if (!random_scif.checked && !random_myst.checked && random_fant.checked && !random_real.checked && !random_dtct.checked) { random_fant.disabled = true } else
    if (!random_scif.checked && !random_myst.checked && !random_fant.checked && random_real.checked && !random_dtct.checked) { random_real.disabled = true } else
    if (!random_scif.checked && !random_myst.checked && !random_fant.checked && !random_real.checked && random_dtct.checked) { random_dtct.disabled = true } else
    {
      random_scif.disabled = false;
      random_myst.disabled = false;
      random_fant.disabled = false;
      random_real.disabled = false;
      random_dtct.disabled = false;
    }
    if (genre) {
      $.ajax({ url: "/switchrandomworkgenre?genre="+genre, success: function(data) { GetRandomWork(); } });
    }
}
