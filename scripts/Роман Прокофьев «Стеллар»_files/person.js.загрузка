$(document).ready(function() {
  $( "select[name='sort']" ).on( 'change', ChangeSort );
  $( "select[name='country_id']" ).on( 'change', ChangeCountryId );
  $( "select[name='category']" ).on( 'change', ChangeCategory );
});

$(document).ready(function() {
    // выбор страны в админском списке переводчиков
    $("#admin_translator_select").on('change', function() {
        var country_id = $(this).val();

        $(window).prop('location').href = $(this).attr('data-select-url') + "&country_id=" + country_id;
    });
});

$(document).ready(function() {
  $("#editions-onoff").click(
    function () {
        $(".editions-blocks").toggle("fast");
        //$(".editions-blocks").toggleClass('editions-blocks-close');

        var al = $.cookie("coversview") || "";
        if (al == 'on') {
            $.cookie('coversview', null);
            $("#editions-onoff").attr("class", 'submenu1');
        } else {
            $.cookie('coversview', 'on');
            $("#editions-onoff").attr("class", 'submenu1 active');
        }


    }
  );
});

// выбор страны в регистрации и в поиске посетителей
// использует глобальные переменные country_id, region_id, city_id, которые можно задать в html.ep
$(document).ready( function() {
    // Загрузка регионов

    $('td.adresses').on('change', '#countryid', function() {
        $('#regionid').remove();
        $('#cityid').remove();

        $.getJSON('/js/address/region' + $(this).val() + '.json?v=4', function(data) {
            var ptitle = $('#regiondiv').data('placeholder') || 'выберите регион...';
            var items = ['<select id="regionid" name="regionid" style="width:200px"><option value="0" style="color:gray">'+ptitle+'</option>'];

            var divider_printed = 0;
            var has_big_level   = 0;

            $.each(data, function(key, val) {
                if ( val[2] > 0 ) { has_big_level = 1; }

                if ( !divider_printed && val[2] == 0 && has_big_level ) {
                    items.push('<option value="0" disabled>&mdash;</option>');
                    divider_printed = 1;
                }

                selected = '';

                if ( window.region_id > 0 && val[0] == window.region_id ) { selected =' selected'; }

                items.push('<option value="' + val[0] + '"' + selected + '>' + val[1] + '</option>');
            });

            items.push('</select>');

            $('#regiondiv').html( items.join('') ).show();
            if (window.region_id || window.city_id) { $("#regionid").trigger("change"); }
        });
    });

    // Загрузка городов
    $('td.adresses').on('change', '#regionid', function() {
        $('#cityid').remove();
        $.getJSON('/js/address/city' + $(this).val() + '.json?v=4', function(data) {
            var ptitle = $('#citydiv').data('placeholder') || 'выберите город...';
            var items = ['<select id="cityid" name="cityid" style="width:200px"><option value="0" style="color:gray">'+ptitle+'</option>'];

            var divider_printed = 0;
            var has_big_level   = 0;

            $.each(data, function(key, val) {
                if ( val[2] > 0 ) { has_big_level = 1; }

                if ( !divider_printed && val[2] == 0 && has_big_level ) {
                    items.push('<option value="0" disabled>&mdash;</option>');
                    divider_printed = 1;
                }

                selected = '';

                if ( window.city_id > 0 && val[0] == window.city_id ) { selected =' selected'; }

                items.push('<option value="' + val[0] + '"' + selected + '>' + val[1] + '</option>');
            });

            items.push('</select>');

            $('#citydiv').html( items.join('') ).show();
        });
    });

    // Загрузка стран
    if($('#countrydiv').length > 0) $.getJSON('/js/address/countries.json?v=4', function(data) {
        var ptitle = $('#countrydiv').data('placeholder') || 'выберите страну...';
        // Загрузка списка стран
        var items = ['<select id="countryid" name="countryid" style="width:200px"><option value="0" style="color:gray">'+ptitle+'</option>'];

        var divider_printed = 0;
        var has_big_level   = 0;

        $.each(data, function(key, val) {
            if ( val[2] > 0 ) { has_big_level = 1; }

            if ( !divider_printed && val[2] == 0 && has_big_level ) {
                items.push('<option value="0" disabled>&mdash;</option>');
                divider_printed = 1;
            }

            selected = '';

            if ( window.country_id > 0 && val[0] == window.country_id ) { selected =' selected'; }

            items.push('<option value="' + val[0] + '"' + selected + '>' + val[1] + '</option>');
        });

        items.push('</select>');

        $('#countrydiv').html( items.join('') ).show();
        if (window.country_id || window.region_id) { $("#countryid").trigger("change"); }
    });
});

function ChangeSort( event ) {
  var $sort_item = $( "select[name='sort']" );
  var sort = $sort_item.find( 'option' ).eq( $sort_item.prop( 'selectedIndex' ) ).val();
  var queryParameters = {}, queryString = location.search.substring(1), re = /([^&=]+)=([^&]*)/g, m; 
  while ( m = re.exec(queryString) ) {
    queryParameters[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
  }
  queryParameters['sort'] = sort;
  delete queryParameters['page'];
  location.search = $.param(queryParameters);
  return false;
}

function ChangeCountryId( event ) {
  var $item = $( "select[name='country_id']" );
  var value = $item.find( 'option' ).eq( $item.prop( 'selectedIndex' ) ).val();
  var queryParameters = {}, queryString = location.search.substring(1), re = /([^&=]+)=([^&]*)/g, m;
  while ( m = re.exec(queryString) ) {
    queryParameters[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
  }
  if (value > 0) {
    queryParameters['country_id'] = value;
  } else {
    delete queryParameters['country_id'];
  }
  delete queryParameters['page'];
  location.search = $.param(queryParameters);
  return false;
}

function ChangeCategory( event ) {
  var $item = $( "select[name='category']" );
  var value = $item.find( 'option' ).eq( $item.prop( 'selectedIndex' ) ).val();
  var queryParameters = {}, queryString = location.search.substring(1), re = /([^&=]+)=([^&]*)/g, m;
  while ( m = re.exec(queryString) ) {
    queryParameters[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
  }
  if (value && value != '0') {
    queryParameters['category'] = value;
  } else {
    delete queryParameters['category'];
  }
  delete queryParameters['page'];
  location.search = $.param(queryParameters);
  return false;
}
