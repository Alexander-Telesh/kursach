$(document).ready(function() {
  $( '#bcase_sel' ).on( 'change' , {
    offset: 0,
  }, BookCaseChangeJSON);
  $( "#right_link" ).on( 'click' , {
    offset: 10,
  }, BookCaseChangeJSON);
  if ( $( '#bcase_sel' ).size() ) {
    BookCaseChangeJSON({
      data: {
        offset: 0,
      }
    });
  }
});

function BookCaseChangeJSON( event ) {
  var list = $( '#bcase_sel' );
  var option = list.find( 'option' ).eq( list.prop('selectedIndex') );
  var bcase_id = option.val() || 0;
  var offset = event.data.offset || 0;
  var bcase_type = option.parent().prop('title') || 'edition';

  /*-----------------*/
  var case_cont = $( '#bcase_cont' );
  var parent_panel = case_cont.parent();
  var load_img = $( '#ch_load' );
  var img = $('#ch_load_img');

  /*-----------------*/
  $.ajax({
    url: '/bookcasechange' + bcase_id + '/?offset=' + offset + '&type=' + bcase_type,
    dataType: 'json',
    async: true,
    beforeSend: function() {
      load_img.width(parent_panel.innerWidth());
      load_img.height(parent_panel.innerHeight());
      load_img.css({
        display: 'block',
        top: 0,
        left: 0,
      });
      img.css({
        display: 'block',
        top: ( parent_panel.outerHeight() - img.find('img').outerHeight() ) / 2,
        left: ( parent_panel.outerWidth() - img.find('img').outerWidth() ) / 2,
      });
    },
    complete: function() {
      load_img.css( 'display', 'none' );
      img.css( 'display', 'none' );
    },
    success: function( json ) {
      var res;
      if ( json.count != 0 ) {
        res = '<ul id="bcase-left" class="' + json.bookcase_type + 's">';
        $.each( json.bookcase_items, function() {
          res += '<li>';
          if ( json.bookcase_type == 'work' ) {
            res += '<a class="x" title="удалить" href="javascript://" onclick="BookCaseWorkDelete(' + this.bookcase_item_id + ');"></a>'
                +  ( this.autor_name ? this.autor_name + '<br>' : '' )
                +  '<a href="/work' + this.item_id + '" title="' + ( this.item_comment || '' ) + '">'
                +  ( this.rusname ? '«' + this.rusname + '»' : '«' + this.name + '»' )
                +  '</a>'
                +  ( this.rusname && this.name ? '<br><i>' + this.name + '</i>' : '' );
          }
          else if ( json.bookcase_type == 'edition' ) {
            res += '<a class="x" title="удалить" href="javascript://" onclick="BookCaseWorkDelete(' + this.bookcase_item_id + ');"></a>'
                +  ( this.autors ? this.autors + '<br>' : '' )
                +  '<a href="/edition' + this.edition_id + '" title="' + ( this.item_comment || '' ) + '">«' + this.name + '»</a><br>'
                +  '<i>' + this.publisher + '</i>';
          }
          else if ( json.bookcase_type == 'film' ) {
            res += '<a class="x" title="удалить" href="javascript://" onclick="BookCaseWorkDelete(' + this.bookcase_item_id + ');"></a>'
                +  ( this.director ? this.director + '<br>' : '' )
                +  '<a href="/film' + this.film_id + '" title="' + ( this.item_comment || '' ) + '">'
                +  ( this.rusname ? '«' + this.rusname + '»' : '«' + this.name + '»' )
                +  '</a><br>'
                +  ( this.rusname && this.name ? '<i>' + this.name + '</i><br>' : '' )
                +  '<i>' + this.country + ', ' + this.year + '</i>';
          }
          else if ( json.bookcase_type == 'autor' ) {
            res += '<a class="x" title="удалить" href="javascript://" onclick="BookCaseWorkDelete(' + this.bookcase_item_id + ');"></a>'
                +  ( this.is_opened ? '<a href="/autor' + this.autor_id + '"' : '<span class="agray"')
                +  ' title="' + ( this.item_comment || '' ) + '">'
                +  this.rusname
                +  ( this.is_opened ? '</a>' : '</span>') + '<br>'
                +  ( this.name ? '<i>' + this.name + '</i><br>' : '' );
          }
          res += '</li>';
          return true;
        });
        res += '</ul>';
      }
      else {
        if ( json.bookcase_type == 'edition' ) {
          res = 'На этой полке нет ни одного издания.'
        }
        else if ( json.bookcase_type == 'work' ) {
          res = 'На этой полке нет ни одного произведения.'
        }
        else if ( json.bookcase_type == 'film' ) {
          res = 'На этой полке нет ни одного фильма.'
        }
        else if ( json.bookcase_type == 'autor' ) {
          res = 'На этой полке нет ни одного автора.'
        }
      }
      if ( json.count > 10 ) {
        res += '<div class="pm-hr"></div>';
        //три состояния
        //первая страница пейджера, левая стрелка отключена
        if ( json.offset == 0 ) {
          res += '<div align="center">'
              +  '<a href="javascript://" style="display:none;" rel="0"><-</a> Страница 1 из ' + json.page_count + ' <a id="right_link" href="javascript://">-></a>'
              +  '</div>';
        } //последняя страница пейджера, правая стрелка отключена
        else if ( json.offset_h >= json.count ) {
          res += '<div align="center">'
              +  '<a id="left_link" href="javascript://" rel="' + json.offset + '"><-</a> Страница ' + json.page_count + ' из ' + json.page_count + ' <a href="javascript://" style="display:none;">-></a>'
              +  '</div>';
        }
        else {
          res += '<div align="center">'
              +  '<a id="left_link" href="javascript://" rel="' + json.offset + '"><-</a> Страница ' + json.current_page + ' из ' + json.page_count + ' <a id="right_link" href="javascript://">-></a>'
              +  '</div>';
        }
      }
      case_cont.html(res);
      $( "#left_link" ).on( 'click' , {
            offset: json.offset - 10,
          }, BookCaseChangeJSON);
      $( "#right_link" ).on( 'click' , {
            offset: json.offset_h,
          }, BookCaseChangeJSON);
      $( '#bcase_footer' ).html( 'Всего на полке: ' + json.count + ' <a href="/user' + json.user_id +'/bookcase' + json.bookcase_id + '">[открыть]</a>' );
    },
  });

  return false;
}

function BookCaseWorkDelete( work_id ) {
  if ( !work_id ) {
    return;
  }

  var list = $( '#bcase_sel' );
  var option = list.find( 'option' ).eq( list.prop( 'selectedIndex' ) );
  var bcase_id = option.val();
  var bcase_type = option.parent().prop( 'title' );

  $.post( '/bookcaseworkdelete' + work_id, function() {
    var left_link = $( '#left_link' );
    var offset = 0;
    if ( left_link ) {
      offset = left_link.attr( 'rel' );
      if ( $( '#bcase_cont li' ).size() == 1 ) {
        offset -= 10;
      }
    }
    BookCaseChangeJSON({
      data: {
        offset: offset,
      }
    });
  });
  return false;
}

    var bookcaseform_loaded = 0
    var imgloading = "<img src='/img/loadingmini.gif' width=20 height=20 border=0 alt='&infin;'>";
    var imgloading_bookcase = "<img src='/img/loadmini_bookcase.gif' width=14 height=14 border=0 alt='&infin;'>";

    function LoadBookCaseForm(work_edition_id,type)
    {
      if (!work_edition_id) { return }
      if (bookcaseform_loaded == 0)
      {
        var random_num = (Math.round((Math.random()*Math.random()*10001)+1));
        var req = getXmlHttp();
        req.open("GET", "/bookcaseset"+type+work_edition_id+"form?"+random_num, false);
        req.send(null);
        if (req.readyState == 4)
        {
          if(req.status == 200) { document.getElementById("bookcaseframe").innerHTML=req.responseText }

        }
        bookcaseform_loaded = 1;
      }
    }

    function LoadBookCaseForm_1(work_edition_id,type)
    {
      if (!work_edition_id) { return }
      if (bookcaseform_loaded == 0)
      {
        var random_num = (Math.round((Math.random()*Math.random()*10001)+1));
        var req = getXmlHttp();
        req.open("GET", "/bookcaseset"+type+work_edition_id+"form?"+random_num, false);
        req.send(null);
        if (req.readyState == 4)
        {
          if(req.status == 200) { document.getElementById("bookcaseframe").innerHTML=req.responseText }
        }
        bookcaseform_loaded = 1;
      }
    }
   
    // не используется, расширенная функция ниже
    /* function BookCaseCheckClick(work_edition_id,bc_id,vote)
    {
      if (!work_edition_id) { return }
        vote = document.getElementById("bc"+bc_id).checked;
        document.getElementById("bcload"+bc_id).innerHTML = imgloading;
        var random_num = (Math.round((Math.random()*Math.random()*10001)+1));
        var req = getXmlHttp();
        req.open("GET", "/bookcaseclick"+work_edition_id+"bc"+bc_id+"change"+vote, false);
        req.send(null);
        if (req.readyState == 4)
        {
          if(req.status == 200) {
                  document.getElementById("bcload"+bc_id).innerHTML="";
          }
        }
    } */
    // не используется
    function save_bcase_id(bcase_id, bcase_type) {
      var expires = new Date();
      expires.setTime(expires.getTime() + (1000 * 86400 * 365));
      document.cookie = "bookcase=" + escape(bcase_id) + "_" + escape(bcase_type) + "; expires=" + expires.toGMTString() + "; path=/; domain= fantlab.ru;";
    }

    function BookCaseCheckClick(work_edition_id, bc_id){

      var galka_elem = document.getElementById("galka_" + work_edition_id + "_" + bc_id);
      var memory_input = document.getElementById("memoriz_" + work_edition_id).value;

      if (galka_elem.rel == "true") {
        vote = "false"
        galka_elem.rel = "false";
        galka_elem.innerHTML = '&#9633;';
        galka_elem.style.color = '#aaa';

        document.getElementById("bccommblock_" + work_edition_id + "_" + bc_id).style.display = 'none';
        document.getElementById("bccomm_" + work_edition_id + "_" + bc_id).innerHTML = '';
        document.getElementById("row_" + work_edition_id + "_" + bc_id).style.display = "none";
        //удаление позиции из списка
        if (memory_input < 2) {
          document.getElementById("bcases_" + work_edition_id).style.display = "none";
          document.getElementById("bc_message_" + work_edition_id).style.display = "block";
        }
        memory_input--;
        document.getElementById("memoriz_" + work_edition_id).value = memory_input;
      }
      else {
        galka_elem.rel = "true";
        vote = "true";
        galka_elem.innerHTML = '&#9632;';
        galka_elem.style.color = '#3277A7';
        document.getElementById("bccommblock_" + work_edition_id + "_" + bc_id).style.display = '';
        if (memory_input == 0) {
          document.getElementById("bc_message_" + work_edition_id).style.display = "none";
          document.getElementById("bcases_" + work_edition_id).style.display = "";
        }
        memory_input++;
        document.getElementById("memoriz_" + work_edition_id).value = memory_input;
        document.getElementById("row_" + work_edition_id + "_" + bc_id).style.display = "";
        //document.getElementById("row_" + work_edition_id + "_" + bc_id).style.display = "block";
      }
      //var IE = (navigator.appName == "Microsoft Internet Explorer"?true:false);
      var prev_state;
      /*if (IE) {
        prev_state = document.getElementById("ie_img_" + work_edition_id + "_" + bc_id).innerHTML;
        document.getElementById("ie_img_" + work_edition_id + "_" + bc_id).innerHTML = imgloading;
      }*/
      if (!work_edition_id) {
        return;
      }
      //var random_num = (Math.round((Math.random()*Math.random()*10001)+1));
      var req = getXmlHttp();
      req.open("GET", "/bookcaseclick" + work_edition_id + "bc" + bc_id + "change" + vote, true);
      /*if (IE) {
        req.onreadystatechange = function(){
          if (req.readyState == 4) {
            if (req.status == 200) {
              document.getElementById("ie_img_" + work_edition_id + "_" + bc_id).innerHTML = prev_state;
            }
          }
        };
      }*/
      req.send(null);
    }

    function SetItemComment(work_edition_id,bc_id,titl)
    {
      titl = titl || 'заметка к позиции';
      var c = prompt(titl, document.getElementById("bccomm_"+work_edition_id+"_"+bc_id).innerHTML );
      if (c != null) {
        if (c.length > 255) { // укоротим текст до 255 символов, больше всё равно в базу не пишется
            c = c.substring(0, 255);
        }
        var random_num = (Math.round((Math.random()*Math.random()*10001)+1));
        var req = getXmlHttp();
        req.open("GET", "/bookcasecomm"+bc_id+"item"+work_edition_id+"comm?txt="+escapeEx(c)+"&"+random_num, false);
        req.send(null);
        document.getElementById("bccomm_"+work_edition_id+"_"+bc_id).innerHTML=c;
        document.getElementById("bccommblock_"+work_edition_id+"_"+bc_id).style.display='';
      var p_bccomm = document.getElementById("p_bccomm_"+work_edition_id+"_"+bc_id);
      if (c == "") {
        p_bccomm.style.display = 'none';
      }
      else {
        p_bccomm.style.display = 'inline';
        p_bccomm.setAttribute("title", c);
      }
      }
    }

    function BookCaseItemDel(work_edition_id,bc_id)
    {
      if (confirm("Убрать позицию с полки?")) {
        var random_num = (Math.round((Math.random()*Math.random()*10001)+1));
        var req = getXmlHttp();
        req.open("GET", "/bookcaseclick"+work_edition_id+"bc"+bc_id+"change"+"false", false);
        req.send(null);
        document.getElementById("e"+work_edition_id).style.backgroundColor = '#dddddd';
        document.getElementById("e"+work_edition_id).style.color = '#aaaaaa';
        document.getElementById("e"+work_edition_id).style.opacity = '0.6';
        document.getElementById("e"+work_edition_id).style.pointerEvents = 'none';
      }
    }

    function BookCaseCreate(work_edition_id, bookcasetype, c)
    {
        document.getElementById("bcnew").innerHTML = imgloading;
        var random_num = (Math.round((Math.random()*Math.random()*10001)+1));
        var req = getXmlHttp();
        req.open("GET", "/bookcasecreate"+bookcasetype+"?name="+escapeEx(c)+"&type="+bookcasetype+"&shared=on&"+random_num, false);
        req.send(null);
        if (req.readyState == 4)
        {
          if(req.status == 200) {
            if(req.responseText.indexOf("Ok")>-1) {
              bookcaseform_loaded=0;
              LoadBookCaseForm(work_edition_id,bookcasetype);
        }
          }
        }
    }

    function BookCaseCreateNew(work_edition_id, bookcasetype, c, user_id)
    {
      var bcnew_elem = document.getElementById("bcnew");
      var prev_state =  bcnew_elem.innerHTML;
        bcnew_elem.innerHTML = imgloading;
        var random_num = (Math.round((Math.random()*Math.random()*10001)+1));
        var req = getXmlHttp();
        //req.open("GET", "/bookcasecreate"+bookcasetype+"?name="+escapeEx(c)+"&type="+bookcasetype+"&shared=on&"+random_num, false);
        req.open("GET", "/user"+user_id+"/bookcases/create?name="+escapeEx(c)+"&type="+bookcasetype+"&shared=on&"+random_num+"&is_ajax=1", false);
        req.send(null);
        if (req.readyState == 4)
        {
          if(req.status == 200) {
            var bc_id = parseInt(req.responseText);

          bookcaseform_loaded = 0;
          bcnew_elem.style.display = "none";
          bcnew_elem.innerHTML = prev_state;
          document.getElementById("bcstr").style.display = "block";
          var bc_case_row = document.createElement("tr");
          bc_case_row.onmouseover = function() {this.style.backgroundColor='#E1E6EC';}
          bc_case_row.onmouseout = function() {this.style.backgroundColor='';}
          //текст скрипта стал монструозным. Из-за бага firefox 3.6
          var bc_case_row_td1 = document.createElement("td");
          //bc_case_row_td1.setAttribute("nowrap","");
          //bc_case_row_td1.setAttribute("class","bctd"); //hover в ie всё равно не работает! Х))))
          bc_case_row_td1.height = "23";
          bc_case_row_td1.style.cursor = "pointer";
          bc_case_row_td1.vAlign = "middle";
          bc_case_row_td1.style.borderTop = "1px solid #3377A8";
          bc_case_row_td1.innerHTML = "<div style=\"float:right;padding:5px;display:inline-block;\"><span id=\"bccommblock_"+work_edition_id + "_" + bc_id+"\"  \
                    title='оставить заметку к позиции' class=\"agray2\" style=\"cursor:pointer;width:auto;display:none;font-style:italic;\" \
                    onclick=\"SetItemComment("+work_edition_id+","+bc_id+")\"># <span id='bccomm_"+work_edition_id+"_"+bc_id+"'></span></span></div>	\
                    <div href=\"javascript://\" class=\"bctxt\" id=\"bctext_"+bc_id+"\" onclick=\"BookCaseCheckClick("+work_edition_id+","+bc_id+")\" \
                    style=\"display:block;cursor:pointer;text-align:left;padding:5px\"> \
                    <a id=\"galka_"+work_edition_id+"_"+bc_id+"\" rel=\"false\" style=\"width:20px;height:20px;text-align:center;font-size:15px;color:#aaa;margin-top:-5px; float:left\">&#9633;</a> \
                    <span id=bcname_"+work_edition_id+"_"+bc_id+"\">"+c+"</span></div>";
          var bc_case_row_td2 = document.createElement("td");
          bc_case_row_td2.width = "20";
          bc_case_row_td2.style.cursor = "pointer";
          bc_case_row_td2.style.borderTop = "1px solid #3377A8";
          bc_case_row_td2.bgColor = "#DFE8EF";
          bc_case_row_td2.align = "center";
          bc_case_row_td2.onmouseover = function() {this.style.backgroundColor='#ffe6ba';}
          bc_case_row_td2.onmouseout = function() {this.style.backgroundColor='#dfe8ef';}
          bc_case_row_td2.innerHTML = "<a style=\"display:block;color:#343233;text-decoration:none;\" href=\"/bookcase"+bc_id+"\">&nbsp;&raquo;&nbsp;</a>";
          bc_case_row.appendChild(bc_case_row_td1);
          bc_case_row.appendChild(bc_case_row_td2);
          var footer_row = bcnew_elem.parentNode.parentNode; //div->td->tr...... *facepalm*
          var bccase_parent = footer_row.parentNode; //не в таблицу надо вставлять, а в tbody!!!!
          bccase_parent.insertBefore(bc_case_row, footer_row);
          //вставляем в постоянную панель
          var bc_panel_row = document.createElement("tr");
          bc_panel_row.id = "row_"+work_edition_id+"_"+bc_id;
          bc_panel_row.style.display = "none";
          bc_panel_row.onmouseover = function() {this.style.backgroundColor='#E1E6EC';}
          bc_panel_row.onmouseout = function() {this.style.backgroundColor='';}
          var bc_panel_row_td1 = document.createElement("td");
          bc_panel_row_td1.height = "23";
          bc_panel_row_td1.style.cursor = "pointer";
          //bc_panel_row_td1.setAttribute("class","bctd");
          bc_panel_row_td1.setAttribute("onclick","bclick"+work_edition_id+"();");
          bc_panel_row_td1.innerHTML = "<span style=\"cursor:pointer; width: 20px; height: 20px; text-align: center; font-size: 15px; margin-top: 0; margin-left:4px; float: left; text-decoration:none;color: #3277A7\"><b>&radic;</b></span> \
              <span style='cursor:pointer;width:auto;padding-top:3;float:left;'>"+c+"</span> \
              <span id=\"p_bccomm_"+work_edition_id+"_"+bc_id+"\" title=\"\" class=\"agray2\" style='display:inline;cursor:pointer;float:right;font-style:italic;padding-top:3px;padding-right:5px;'>#</span>";
          var bc_panel_row_td2 = document.createElement("td");
          bc_panel_row_td2.width = "20";
          bc_panel_row_td2.style.cursor = "pointer";
          bc_panel_row_td2.bgColor = "#DFE8EF";
          bc_panel_row_td2.align = "center";
          bc_panel_row_td2.onmouseover = function() {this.style.backgroundColor='#ffe6ba';}
          bc_panel_row_td2.onmouseout = function() {this.style.backgroundColor='#dfe8ef';}
          bc_panel_row_td2.innerHTML = "<a style='display:block;color:#343233;text-decoration:none;' href=/bookcase"+bc_id+">&nbsp;&raquo;&nbsp;</a>\n";
          bc_panel_row.appendChild(bc_panel_row_td1);
          bc_panel_row.appendChild(bc_panel_row_td2);
          //фикс для ie
          var bcase_panel = document.getElementById("bcases_"+work_edition_id);
          bcase_panel.getElementsByTagName("tbody")[0].appendChild(bc_panel_row); 
          document.getElementById("bcnot").style.display="none";
          document.getElementById("bcnewform").style.display="none";
          }
        }
    }

    function Hide(element)
    {

    }

// берёт название нового шкафа и активирует форму создания
function createFolder() {
  const folderName = prompt("Введите имя нового шкафа:");
  
  if (folderName) {
      $('#folderName').val(folderName);
      $('#createFolderForm').submit();
  }
}
// асинхронно обращается за переименованием указанного шкафа, в случае успеха подсвечивая ненадолго новое название
function renameFolder(userId, folderId) {
  const newName = prompt("Введите новое имя шкафа:");

  if (newName) {
      $.ajax({
          url: `/user${userId}/bookcases/folder${folderId}/rename`,
          type: 'POST',
          data: { folder_name: newName },
          success: function(response) {
              if (response.success) {
                  const $folderName = $('#folder-name-' + folderId);
                  $folderName.text(newName.slice(0, 50));

                  // применяем временную подсветку изменения
                  $folderName.css({ backgroundColor: "#ffff99" }); 
                  setTimeout(function() {
                      $folderName.animate({ backgroundColor: "#ffffff" }, 1500); 
                  }, 1000);
              } else {
                  alert("Не удалось переименовать шкаф. Ошибка: " + (response.error || "Попробуйте снова."));
              }
          },
          error: function() {
              alert("Произошла ошибка при переименовании. Попробуйте снова.");
          }
      });
  }
}    
function deleteFolder(userId, folderId) {
  if (confirm("Вы уверены, что хотите удалить этот шкаф? Его содержимое будет перенесено в корневые полки.")) {
      $.ajax({
          url: `/user${userId}/bookcases/folder${folderId}/remove`,
          type: 'POST', 
          success: function(response) {
              if (response.success) {
                $("#folder-row-" + folderId).remove(); 
                $("#folder-row-down-" + folderId).remove(); 
              } else {
                  alert("Ошибка при удалении шкафа.");
              }
          },
          error: function() {
              alert("Произошла ошибка при удалении. Попробуйте снова.");
          }
      });
  }
}
// переключает режим отображения полки, записывает новый в куки и перезагружает в новом виде страницу
function toggleViewBookcase(mode) {
  var dateForCookie= new Date();
  dateForCookie.setFullYear(dateForCookie.getFullYear() + 1);  
  document.cookie = "bookcase_view=" + mode + "; path=/; expires=" + dateForCookie.toUTCString();
  location.reload(); 
}
// переключает режим отображения списка полок
function toggleViewBookcaseList(mode) {
  var dateForCookie = new Date();
  dateForCookie.setFullYear(dateForCookie.getFullYear() + 1);  
  document.cookie = "bookcase_list_view=" + mode + "; path=/; expires=" + dateForCookie.toUTCString();
  location.reload(); 
}

function getCookie(name) {
  let matches = document.cookie.match(new RegExp(
      "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
  ));
  return matches ? decodeURIComponent(matches[1]) : null;
}  
// функция срабатывает при перемщении полки в плиточном режиме, отправляя на сервер новый порядок сортировки 
function SortElements(e, user_id, folder_id) {
  var parent = e.parent();
  var hiddenInputs = parent.find('input[type="hidden"]');
  hiddenInputs.each(function(index) {
    $(this).val(index + 1); 
  });

  var data = {
    user_id: user_id, 
    folder_id: folder_id,
    is_ajax: 1
  };

  // проходим по каждому скрытому полю и добавляем его в объект данных
  hiddenInputs.each(function(index) {
    var input = $(this);
    if (input.attr('name') && input.attr('name').startsWith('bc')) {
      data[input.attr('name')] = input.val();
    }
  });

  $.ajax({
    url: '/user'+ user_id +'/bookcases/sort/folder' + folder_id, // URL для отправки
    method: 'POST', 
    data: data, 
    success: function(response) {

    },
    error: function(xhr, status, error) {
      alert("Ошибка при сохранении сортировки: " + error);
    }
  });

}