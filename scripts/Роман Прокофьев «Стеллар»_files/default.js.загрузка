$(document).ready(function () {
    // портфель
    $("#pf-link").click(function() {
        $(".portfolio").toggle();
    });
    $("#pf-close").click(function() {
        $(".portfolio").hide();
    });

    // закрытие блока портфеля по клику в любое место экрана
    $(document).on('mouseup', function(e) {
        var container = $(".hide-on-click-out");
        var pfLink = $(e.target).closest("#pf-link")
        if (!container.is(e.target) && container.has(e.target).length === 0 && pfLink.length==0)
        {
            container.hide();
            if (window.flag) { flag = 'off' }
        }

        // к селектору оценок другой подход (по visibility)
        var container2 = $(".selector");
        var container3 = $(".author_mark");
        if (!container2.is(e.target) && container2.has(e.target).length === 0
         && !container3.is(e.target) && container3.has(e.target).length === 0)
        {
            if (window.selector) { selector.style.visibility = "hidden"; };
            if (window.pr_e) { pr_e.style.borderColor = ""; };
        }

        // блок смайликов тоже скрываем
        var container3 = $(".smilesdiv");
        var container4 = $(".addsmilesbutton");
        if (!container3.is(e.target) && container3.has(e.target).length === 0 &&
            !container4.is(e.target) && container4.has(e.target).length === 0)
        {
          if (window.smiles) { FlipSmiles(-1,-1,1) }
        }
    });

    // закрытие левых блоков.
    $(".left-block-title-container").click(function() {
        $(this).parent().children('.left-block-body').slideToggle('normal');
        $(this).parent().toggleClass('left-block-close');
        var al = $.cookie("leftblocks") || "";
        var wg = $(this).parent().attr("id");
        if (al.indexOf(wg) > -1) {
            al = al.replace(wg, '');
        } else {
            al = al + wg;
        }
        $.cookie("leftblocks", al);
    });

    /* bbcode: спойлер */
    $(".hidden-spoiler div").click(function() {
        if(this.style.color=='black') {
            $(this).css( "color", "F9FAFB" );
        }
        else {
            $(this).css( "color", "black" );
        }
    });

    // загловочный блок
    $('.main-info-block .main-info-block-header.block-allow-toggle').click(function() {
        //$(this).toggleClass('block-close');
        //$(this).next().toggle();
        $(this).toggleClass('block-close');
        var wg = $(this).attr("for");
        $("#"+wg).toggle();
        var al = $.cookie("autorblocks") || "";
        if (al.indexOf(wg) > -1) {
            al = al.replace(wg, '');
        } else {
            al = al + wg;
        }
        $.cookie("autorblocks", al);
    })

    // блоки ворков на странице автора
    $('.biblio-show-block .main-info-block-header.block-allow-toggle').click(function() {
        $(this).toggleClass('block-close');
        var wg = $(this).attr("for");
        $("#"+wg).toggle();
        var al = $.cookie("autorblocks") || "";
        if (al.indexOf(wg) > -1) {
            al = al.replace(wg, '');
        } else {
            al = al + wg;
        }
        $.cookie("autorblocks", al);
    })


    // Person award view all list
    $(".person-info-award-viewlist").click(function() {
        $(".person-info-award-block-second").show();
        $(".person-info-award-viewlist").hide();
    });

    $("#pubcontry_select").change(function() {
        window.location = $(this).val();
    });

    $("#translator_sort").change(function() {
        window.location = $(this).val();
    });

    $(".openedition").click(function() {
        var textarea_elem = $(this).parent().next();
        textarea_elem.toggle();
    });

    $(".bookashko-logo4-bklens1").click(function() {
        $(this).toggleClass( "bookashko-logo4-bklens2" );
    });


    // Person award sorting selector
    $("#awards_person_sort").change(function() {
        var newaction = $('#award_person_link').attr('href');
        document.location.href = newaction + "/awards?sort=" + this.value;
    });

    $("#awards_sort").change(function() {
        location.href='/awards?sort=' + $(this).val()+'&nonfant='+($("[name=nonfant]").prop("checked")?1:0);
    });

    // Adds a country to a person
    $('#btn_add_country').click(function() {
        var num     = $('.cloned-input').length;
        var newNum  = new Number(num + 1);

        var newElem = $('#select_country_' + num).clone().attr('id', 'select_country_' + newNum);

        newElem.children('label').attr('for', 'person_country_' + newNum).attr('name', 'name' + newNum);
        newElem.children('div').children('select').attr('id', 'person_country_' + newNum).attr('name', 'person_country_' + newNum);
        $('#select_country_' + num).after(newElem);

        $('#select_country_' + newNum + ' :nth-child(1)').attr('selected', 'selected');
        if (newNum == 3)
            $('#btn_add_country').prop("disabled", true);
    });


    if ($('.cloned-input').length == 3) {
       $('#btn_add_country').prop("disabled", true);
    }

    // Tool buttons
    $(".tagbutton").click(function() {
        var textarea_elem = $(this).parent().parent().next().next().children('textarea').attr("id");
        if ($(this).attr("name") == "tag_img")
        {
          image(textarea_elem);
        }
        else if ($(this).attr("name") == "tag_url")
        {
          url(textarea_elem);
        }
        else if ($(this).attr("name").substring(0,3) == "tag")
        {
          var tag_button = $(this).attr("name").replace("tag_", "");
          simpletag(tag_button, textarea_elem);
        }
        else
        {
          var str_insert = $(this).attr("value");
          doInsert(str_insert,"",false, textarea_elem);
        }
    });

    //Blog Subscription
    $("a.blog_subscribe").click(function() {
        var blog_id = $(this).prev().val() || $(this).attr('data-blog-id');
        var blog_link = '/editblog' + blog_id + 'subscriber';
        var img_elem = '#img_subscribe_blog' + blog_id;
        $(img_elem).attr('src', '/img/subscr_process.gif');
        for (var i = 1; i <= 10; i++) {
            img_elem = '#img_subscribe_blog' + blog_id + '_' + i;
            $(img_elem).attr('src', '/img/subscr_process.gif');
        }

        $.ajax({
            url: blog_link,
            success: function (json) {
                var img_src;
                if (json.is_subscribed == 'on') { img_src = '/img/subscr.png' } else { img_src = '/img/subscr_empty.png' }
                var img_elem = '#img_subscribe_blog' + blog_id;
                $(img_elem).attr('src', img_src);
                for (var i = 1; i <= 10; i++) {
                    img_elem = '#img_subscribe_blog' + blog_id + '_' + i;
                    $(img_elem).attr('src', img_src);
                }
            }
        });
    });

    //Topic Subscription
    $("a.topic_subscribe").click(function() {
        var topic_id = $(this).prev().val();
        var topic_link = '/edittopic' + topic_id + 'subscriber';
        var img_elem = '#img_subscribe_topic' + topic_id;
        $(img_elem).attr('src', '/img/subscr_process.gif');

        $.ajax({
            url: topic_link,
            success: function (json) {
                if (json.is_subscribed == 'on') {
                    $(img_elem).attr('src', '/img/subscr.png');
                } else {
                    $(img_elem).attr('src', '/img/subscr_empty.png');
                }
            }
        });
    });

    //Forum Topic Subscription
    $("a.forum_topic_subscribe").click(function() {
        var topic_id = $(this).prev().val();
        var topic_link = '/editforumtopic' + topic_id + 'subscriber';
        var img_elem = '#img_subscribe_topic' + topic_id;
        $(img_elem).attr('src', '/img/subscr_process.gif');

        $.ajax({
            url: topic_link,
            success: function (json) {
                if (json.is_subscribed == 'on') {
                    $(img_elem).attr('src', '/img/subscr.png');
                } else {
                    $(img_elem).attr('src', '/img/subscr_empty.png');
                }
            }
        });
    });

    //Edition Subscription (when it's published)
    $("a.edition_subscribe").click(function() {
        var edition_id = $(this).prev().val();
        var edition_link = '/editedition' + edition_id + 'subscriber';
        var img_elem = '#img_subscribe_edition' + edition_id;
        var edition_subscribed_count_span = '#edition_subscribed_count_span'
        $(img_elem).attr('src', '/img/subscr_process.gif');

        $.ajax({
            url: edition_link,
            success: function (json) {
                if (json.is_subscribed == 'on') {
                    $(img_elem).attr('src', '/img/subscr.png');
                } else {
                    $(img_elem).attr('src', '/img/subscr_empty.png');
                }
                $(edition_subscribed_count_span).text(json.subscribed_count);
            }
        });
    });


    //Content Subscription (Notification)
    $("a.content_subscribe").click(function() {
        var subs_id = $(this).attr('data-subs-id');
        var content_id = $(this).attr('data-content-id');
        var img_id = $(this).attr('data-img-id');
        var img_elem = '#img_subscribe_content_'+img_id;
        var data_elem = this;

        if (subs_id == '') {
            var link = '/notification/subscribe/'+content_id+'.json';
            
            $(img_elem).attr('src', '/img/subscr_process.gif');

            $.ajax({
                url: link,
                success: function (json) {
                    if (json.status == 1) {
                        $(img_elem).attr('src', '/img/subscr.png');
                        $(data_elem).attr('data-subs-id', json.id);
                    } else {
                        $(img_elem).attr('src', '/img/subscr_empty.png');
                    }
                }
            });
        } else {
            var link = '/notification/unsubscribe/'+subs_id+'.json';
            
            $(img_elem).attr('src', '/img/subscr_process.gif');

            $.ajax({
                url: link,
                success: function (json) {
                    if (json.status == 1) {
                        $(img_elem).attr('src', '/img/subscr_empty.png');
                        $(data_elem).attr('data-subs-id', '');
                    } else {
                        $(img_elem).attr('src', '/img/subscr.png');
                    };
                }
            });
        };
    });


    $("a[data-track=true]").click(function() {
        var url = "/linkmetric?url=" + $(this).attr("href");

        $.ajax({
            url: url,
            success: function (data) { }
        });
    });

    // сортировка таблицы в магазине на странице произведений
    $(".shop-offers").tablesorter();

    // bootstrap-тултипы в "личной переписке"
    $('#notice-base .pm-iconbutton-c').tooltip();

    // bootstrap-hint для подсказок
    $('.hint').tooltip();

    const $input = $('input[name="searchstr"]');
    const $warning = $('#popup-search-warning');

    const latinToCyrillic = {
        '`':'ё','q':'й','w':'ц','e':'у','r':'к','t':'е','y':'н','u':'г','i':'ш','o':'щ','p':'з','[':'х',']':'ъ',
        'a':'ф','s':'ы','d':'в','f':'а','g':'п','h':'р','j':'о','k':'л','l':'д',';':'ж',':':'ж','\'':'э','\"':'э',
        'z':'я','x':'ч','c':'с','v':'м','b':'и','n':'т','m':'ь',',':'б','.':'ю','/':'.','<':'б','>':'ю',
    };

    const cyrillicToLatin = {};
    for (let key in latinToCyrillic) {
        cyrillicToLatin[latinToCyrillic[key]] = key;
    }
    // регулярками проверяем, есть ли 5 и более согласных в вводимом запросе
    function detectWrongLayout(text) {
        const latinConsonants = 'qwrtpsdfghjklzxcvbnm';
        const cyrillicConsonants = 'йцкнгшщзхъфвпрлджчсмтьб';

        const latinRegex = new RegExp(`[${latinConsonants}]{5,}`, 'i');
        const bracketsRegex = /[\[\]{}<>]|[:;](?!\s)/; // проверяем также наличие [], {}, <> скорее это должны быть х или ъ и т.п., а [:;](?!\s) - знаки препинания без пробела после них
        const cyrillicRegex = new RegExp(`[${cyrillicConsonants}]{5,}`, 'i');
        const specificCyrillic = /(ыы|щц|щы)/i; // специфические комбинации, которые в кириллице обычно не встречаются

        if (latinRegex.test(text) || bracketsRegex.test(text)) return 'latin';
        if (cyrillicRegex.test(text) || specificCyrillic.test(text)) return 'cyrillic';
        return null;
    }
    // конвертирует символы между раскладками
    function convertLayout(text, from) {
        let map = from === 'latin' ? latinToCyrillic : cyrillicToLatin;
        return text.split('').map(char => {
            let lower = char.toLowerCase();
            let converted = map[lower] || char;
            return (char === lower) ? converted : converted.toUpperCase();
        }).join('');
    }
    // проверяем верность раскладки при вводе каждого символа в строке поиска
    // для широких экранов компьютеров, на телефонах там и так всё рядоми видно
    if (window.innerWidth >= 1000) {
        $input.on('input', function () {
            const val = $input.val();
            const layoutIssue = detectWrongLayout(val);

            if (layoutIssue) {
                $warning
                    .slideDown()
                    .off('click')
                    .on('click', function () {
                        const fixed = convertLayout(val, layoutIssue);
                        $input.val(fixed);
                        $warning.hide();
                    });
            } else {
                $warning.hide();
            }
        });
    }
});
